<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ERP System + System Page â€” Mockup</title>
<style>
:root {
  /* Cleaner Light Theme */
  --bg: #f8f9fa;
  --panel: #ffffff;
  --text: #212529;
  --muted: #6c757d;
  --accent: #0d6efd; /* A slightly more vibrant blue */
  --border: rgba(0, 0, 0, 0.05);
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
  --sidebar-bg: linear-gradient(180deg, #ffffff, #fdfdff);
  --radius: 12px; 
  --sidebar-width: 240px;
  --brightness: 1.0;
  font-family: -apple-system, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  filter: brightness(var(--brightness));
}
:root.dark-mode {
  /* Cleaner Default Dark Theme */
  --bg:#1c1c1c;
  --panel:#2d2d30;
  --text:#f3f3f3;
  --muted:#a0a0a0;
  --accent:#3b8eda;
  --border: rgba(255, 255, 255, 0.08);
  --shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
  --sidebar-bg:linear-gradient(180deg,#252526, #2d2d30);
}
:root.theme-slate.dark-mode {
  /* Cleaner "Slate" Dark Theme Option */
  --bg: #0f172a;      /* slate-900 */
  --panel: #1e293b;   /* slate-800 */
  --text: #e2e8f0;     /* slate-200 */
  --muted: #94a3b8;   /* slate-400 */
  --accent: #38bdf8;   /* sky-400 */
  --border: rgba(255, 255, 255, 0.1);
  --sidebar-bg: linear-gradient(180deg, #162033, #1e293b);
}
:root.theme-brand {
  /* Cleaner Brand-Oriented Light Theme */
  --bg: #f8f9fa;
  --panel: #ffffff;
  --text: #111827;
  --muted: #4b5563;
  --accent: #0d6efd;
  --border: rgba(0, 0, 0, 0.05);
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
  --sidebar-bg: #e7f1ff; /* Light blue from accent */
  --radius: 12px;
}


:root.night-light body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;
  background:linear-gradient(rgba(255,180,100,0.15),rgba(255,150,80,0.25));
  pointer-events:none; z-index:9999;
  transition:opacity 0.5s ease;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);transition:background-color 0.3s,color 0.3s;}
.app{display:flex;min-height:100vh; transition: padding-left 0.3s ease;}
.sidebar{
  width:var(--sidebar-width);
  padding:20px;
  background:var(--sidebar-bg);
  border-right:1px solid var(--border);
  transition:width 0.3s ease, background 0.3s;
  flex-shrink: 0;
  overflow: hidden;
}
.brand{display:flex;align-items:center;gap:12px;margin-bottom:18px}
.logo{width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#00a4ff);display:grid;place-items:center;color:#fff;font-weight:700}
.brand h1{font-size:16px;margin:0}
.search{margin-bottom:12px}
.search input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text)}
.nav{display:flex;flex-direction:column;gap:6px}
.nav button{appearance:none;border:0;background:transparent;padding:8px 12px;border-radius:8px;text-align:left;display:flex;align-items:center;gap:12px;font-size:14px;color:var(--muted);cursor:pointer;transition:all 0.2s; font-weight: 500; width: 100%;}
.nav button.active{background:rgba(13,110,253,0.08);color:var(--accent);box-shadow:inset 2px 0 0 0 var(--accent); font-weight: 600;}
.nav button:hover{background:rgba(0,120,215,0.05);}
.spacer{flex:1}
.nav button svg {
  width: 20px; height: 20px; min-width: 20px;
  flex-shrink: 0; /* Prevent icons from shrinking */
}
.nav button span { white-space: nowrap; /* Prevent text from wrapping */ }
.footer{font-size:13px;color:var(--muted)}
.content{flex:1;padding:28px; overflow-x: hidden;}

/* Collapsed Sidebar Styles */
.app.sidebar-collapsed .sidebar { width: 72px; padding: 10px; }
.app.sidebar-collapsed .sidebar .brand > div,
.app.sidebar-collapsed .sidebar .search,
.app.sidebar-collapsed .sidebar .footer,
.app.sidebar-collapsed .nav button span {
  opacity: 0;
  width: 0;
  visibility: hidden;
}
.app.sidebar-collapsed .nav button { justify-content: center; padding: 12px; gap: 0; }
.app.sidebar-collapsed .nav button.active {
  background: rgba(13, 110, 253, 0.15); /* Use a slightly stronger background for the active icon */
  box-shadow: none; /* Remove the left-border indicator */
}


.content{
  flex:1;
  padding:28px;
  max-width: 1600px; /* Add a max-width for better proportionality on large screens */
  margin: 0 auto;    /* Center the content area */
  width: 100%;
}
.page-loader-container {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s, visibility 0.2s;
}
.page-loader-container.visible { opacity: 1; visibility: visible; }
.page-loader {
  width: 40px; height: 40px;
  border: 4px solid var(--accent);
  border-bottom-color: transparent;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
.inline-loader {
  width: 24px; height: 24px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 4px 0; /* Adjust margin to fit well within metric cards */
}

@keyframes spin { to { transform: rotate(360deg); } }

.indicator { font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
.indicator.up { color: #10b981; }
.indicator.down { color: #ef4444; }
.indicator svg { width: 12px; height: 12px; }

.sidebar-toggle-btn {
  appearance: none; border: 0; background: transparent;
  width: 36px; height: 36px;
  display: grid; place-items: center;
  border-radius: 8px;
  cursor: pointer;
  color: var(--muted);
}
.sidebar-toggle-btn:hover {
  background: rgba(0,0,0,0.05);
}
:root.dark-mode .sidebar-toggle-btn:hover { background: rgba(255,255,255,0.05); }

.content-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
.page-title{display:flex;align-items:center;gap:12px}
.page-title h2{margin:0;font-size:20px}
.page-sub{color:var(--muted);font-size:14px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
.header-user-info {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: var(--muted);
}
.user-menu { position: relative; }
.user-menu-trigger {
  display: flex;
  align-items: center;
  gap: 8px;
  background: transparent;
  border: 0;
  padding: 4px 8px;
  border-radius: 8px;
  cursor: pointer;
  color: var(--text);
}
.user-menu-trigger:hover { background: var(--border); }
.user-avatar {
  width: 28px; height: 28px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent) 0%, #00a4ff 100%);
  color: #fff;
  display: grid;
  place-items: center;
  font-size: 12px;
  font-weight: 600;
}
.user-menu .dropdown-content { margin-top: 8px; }

.card{background:var(--panel);border-radius:12px;padding:14px;box-shadow:var(--shadow);border:1px solid var(--border);transition:background 0.3s,border-color 0.3s}
.card.clickable:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.06); cursor: pointer; }
:root.dark-mode .card.clickable:hover { box-shadow: 0 8px 16px rgba(0,0,0,0.25); }

/* Infolet styles inspired by Oracle Fusion */
.infolet-strip {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
}

.infolet {
  display: flex;
  align-items: center;
  gap: 16px;
  min-width: 280px;
  flex: 1;
}
.infolet-icon {
  flex-shrink: 0;
  width: 48px; height: 48px;
  border-radius: 50%;
  display: grid;
  place-items: center;
}
.infolet-icon svg { width: 24px; height: 24px; color: #fff; }

.card h3{margin:0 0 8px 0;font-size:15px}
.card p{margin:0;color:var(--muted);font-size:14px}
.setting-row{display:flex;align-items:center;justify-content:space-between;padding-top:10px}
.toggle{width:44px;height:26px;border-radius:20px;background:#e6edf6;position:relative;cursor:pointer;transition:background 0.3s}
.toggle .knob{position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 2px 6px rgba(2,6,23,0.08);transition:all .18s}
.toggle.on{background:linear-gradient(90deg,var(--accent),#00b0ff)}
.toggle.on .knob{transform:translateX(18px)}
:root.dark-mode .toggle{background:var(--border)}
.list{margin-top:10px;border-radius:10px;overflow:hidden;border:1px solid var(--border)}
.list .item{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;background:transparent;border-bottom:1px solid var(--border)}
.list .item:last-child{border-bottom:0}
input,select{background-color:var(--panel);color:var(--text);border:1px solid var(--border);transition:background-color 0.3s,color 0.3s,border-color 0.3s}
input[type="range"]{background:transparent}
@media (max-width:880px){.sidebar{display:none}.app{flex-direction:column}.content{padding:16px}}
.top-search {
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--panel);
}
.data-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
.data-table th, .data-table td { padding: 12px 14px; text-align: left; border-bottom: 1px solid var(--border); }
.data-table th { font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted); }
.data-table tbody tr:hover { background-color: rgba(0,0,0,0.02); }
:root.dark-mode .data-table tbody tr:hover { background-color: rgba(255,255,255,0.04); }
.status-badge {
  display: inline-block;
  padding: 4px 8px;
  font-size: 11px;
  font-weight: 600;
  border-radius: 999px;
  text-transform: capitalize;
  letter-spacing: 0.5px;
}
.low-stock { color: #f59e0b; font-weight: 600; }
.table-controls { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border); }
.table-controls h4 { margin: 0; font-size: 16px; }
.table-controls .actions { display: flex; gap: 8px; }
.table-controls input { padding: 8px 12px; font-size: 14px; border-radius: 6px; }
.table-controls button { padding: 8px 14px; font-size: 14px; border-radius: 6px; border: 0; background: var(--accent); color: #fff; cursor: pointer; }
.role-chip { padding: 6px 10px; border-radius: 999px; background: var(--bg); cursor: pointer; border: 1px solid var(--border); font-size: 14px; color: var(--text); display: inline-block; margin: 4px; }
.role-chip.active { background: linear-gradient(90deg,var(--accent),#00b0ff); color:#fff; border-color:transparent; }
.role-chip-container { display: flex; flex-wrap: wrap; margin: -4px; }
.action-btn {
  padding: 5px 12px;
  font-size: 13px;
  border-radius: 6px;
  border: 0;
  background: var(--accent);
  color: #fff;
  cursor: pointer;
  transition: filter 0.2s;
}
.action-btn:hover { filter: brightness(1.1); }
.action-btn.danger { background: #e53935; }
.action-btn.danger {
  background: transparent;
  border: 1px solid #e53935;
  color: #e53935;
  transition: background-color 0.2s, color 0.2s;
}
.action-btn.danger:hover { background: #e53935; color: #fff; filter: brightness(1); }
.pos-item-controls { display: flex; align-items: center; gap: 6px; }
.pos-item-controls button {
  width: 32px; height: 32px; padding: 0;
  border-radius: 8px;
  font-size: 14px;
  line-height: 1;
  display: grid;
  place-items: center;
}
.pos-item-remove { background: transparent !important; color: var(--muted) !important; }
.pos-item-remove:hover { color: #e53935 !important; background: rgba(229, 57, 53, 0.1) !important; }


.tab-nav { display: flex; gap: 4px; margin-top: 24px; margin-bottom: 12px; border-bottom: 1px solid var(--border); }
.tab-button { appearance: none; border: 0; background: transparent; padding: 10px 16px; border-radius: 6px 6px 0 0; font-size: 14px; color: var(--muted); cursor: pointer; position: relative; top: 1px; }
.tab-button.active { color: var(--accent); font-weight: 600; border: 1px solid var(--border); border-bottom-color: var(--panel); }
.tab-content { display: none; }
.tab-content.active { display: block; }
.report-metric { font-size: 36px !important; font-weight: 600; }

.actions-group { display: flex; gap: 8px; }
.actions-group button { padding: 8px 16px; font-size: 14px; border-radius: 8px; border: 0; background: var(--accent); color: #fff; cursor: pointer; }
.dropdown { position: relative; display: inline-block; }
.dropdown-content { display: none; position: absolute; background-color: var(--panel); min-width: 160px; box-shadow: var(--shadow); border-radius: 8px; z-index: 50; right: 0; border: 1px solid var(--border); overflow: hidden; }
.user-menu .dropdown-content { margin-top: 8px; }
.dropdown-content a { color: var(--text); padding: 12px 16px; text-decoration: none; display: block; font-size: 14px; }
.dropdown-content a:hover { background-color: rgba(0,120,215,0.08); }
.dropdown:hover .dropdown-content { display: block; }
.dropdown::before {
  content: '';
  position: absolute;
  bottom: -8px; /* Matches the margin-top of the dropdown-content */
  left: 0;
  right: 0;
  height: 8px; /* The height of the gap */
}

@media print {
  body.printing .sidebar,
  body.printing .content-header,
  body.printing .card:has(#reportDateRange),
  body.printing #reports-tab-nav {
    display: none !important;
  }
  body.printing .content {
    padding: 0;
  }
  .tab-content { display: none; } /* Hide all tabs by default */
  .tab-content.active { display: block; } /* Only show the active one */
  .card { box-shadow: none; border: 1px solid #ccc; }
}

.modal-backdrop {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.5); z-index: 1000;
  display: none; align-items: center; justify-content: center;
}
.modal-content {
  background: var(--panel); border-radius: var(--radius);
  width: 90%; max-width: 500px;
  box-shadow: var(--shadow);
}
.modal-header { padding: 16px; border-bottom: 1px solid var(--border); }
.modal-header h4 { margin: 0; font-size: 16px; }
.modal-body { padding: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.modal-body input, .modal-body select { width: 100%; padding: 10px 12px; border-radius: 8px; font-size: 14px; }
.modal-body .full-width { grid-column: 1 / -1; }
.modal-body label { font-size: 13px; color: var(--muted); margin-bottom: 4px; display: block; }
.modal-footer { padding: 12px 16px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
.modal-footer button { padding: 8px 16px; font-size: 14px; border-radius: 8px; border: 0; cursor: pointer; }
.modal-footer #modalSaveBtn { background: var(--accent); color: #fff; }
.modal-footer #modalCloseBtn { background: var(--border); color: var(--text); }


.login-screen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: var(--bg) radial-gradient(circle at 100% 100%, rgba(0,120,215,0.08) 0%, transparent 25%), radial-gradient(circle at 0% 0%, rgba(0,120,215,0.08) 0%, transparent 25%);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  transition: opacity 0.3s ease, visibility 0.3s;
  /* Start hidden to prevent flash on load for authenticated users */
  visibility: hidden;
  opacity: 0;
}
.login-screen.visible {
  opacity: 1;
  visibility: visible;
}
.login-box {
  background: var(--panel);
  padding: 40px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  text-align: center;
  width: 340px;
}
.login-avatar {
  width: 80px; height: 80px;
  border-radius: 50%;
  margin: 0 auto 16px;
  background: linear-gradient(135deg, var(--accent), #00a4ff);
  color: white; display: grid; place-items: center;
  font-size: 32px; font-weight: 600;
}
.login-box h2 { margin: 0 0 24px; font-size: 20px; }
.input-group { position: relative; margin-bottom: 16px; }
.input-group svg { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: var(--muted); }
.login-box input { width: 100%; padding: 12px 12px 12px 40px; border-radius: 8px; text-align: left; }
.login-box button { 
  width: 100%; padding: 12px; border-radius: 8px; border: 0; 
  background: var(--accent); color: #fff; font-size: 15px; cursor: pointer;
  transition: background-color 0.2s;
}
.login-box button:hover { background: #006cbf; }
.login-error { color: #e53935; font-size: 13px; height: 16px; margin-bottom: 8px; }

</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body id="body">
<script>
  // Immediately apply themes from localStorage to prevent FOUC (Flash of Unstyled Content)
  (function() {
    document.body.style.visibility = 'hidden';
    if (localStorage.getItem('theme') === 'brand') document.documentElement.classList.add('theme-brand');
    if (localStorage.getItem('theme') === 'slate') document.documentElement.classList.add('theme-slate');
    if (localStorage.getItem('darkMode') === 'true') document.documentElement.classList.add('dark-mode');
    if (localStorage.getItem('nightLight') === 'true') document.documentElement.classList.add('night-light');
    document.body.style.visibility = 'visible';
  })();
</script>
<div class="app" style="display: none;">
<aside class="sidebar" role="navigation">
  <div class="brand">
    <div class="logo">E</div>
    <div>
      <div style="font-weight:600">ERP System</div>
      <div style="font-size:12px;color:var(--muted);">Mockup</div>
    </div>
  </div>

  <div class="search"><input id="sidebarSearch" placeholder="Search module..." aria-label="Search ERP modules"></div>

  <nav class="nav" id="navList" aria-label="ERP modules">
    <button data-key="dashboard" class="active">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2 4.25A2.25 2.25 0 0 1 4.25 2h11.5A2.25 2.25 0 0 1 18 4.25v11.5A2.25 2.25 0 0 1 15.75 18H4.25A2.25 2.25 0 0 1 2 15.75V4.25ZM4.25 3.5a.75.75 0 0 0-.75.75v11.5c0 .414.336.75.75.75h11.5a.75.75 0 0 0 .75-.75V4.25a.75.75 0 0 0-.75-.75H4.25Z" /><path d="M10 8a.75.75 0 0 1 .75.75v1.5h1.5a.75.75 0 0 1 0 1.5h-1.5v1.5a.75.75 0 0 1-1.5 0v-1.5h-1.5a.75.75 0 0 1 0-1.5h1.5v-1.5A.75.75 0 0 1 10 8Z" /></svg>
      <span>Dashboard</span>
    </button>
    <button data-key="pos">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 4.25A2.25 2.25 0 0 1 4.25 2h11.5A2.25 2.25 0 0 1 18 4.25v11.5A2.25 2.25 0 0 1 15.75 18H4.25A2.25 2.25 0 0 1 2 15.75V4.25ZM4.25 3.5a.75.75 0 0 0-.75.75v11.5c0 .414.336.75.75.75h11.5a.75.75 0 0 0 .75-.75V4.25a.75.75 0 0 0-.75-.75H4.25Z" clip-rule="evenodd" /><path d="M8.25 10a.75.75 0 0 1 .75-.75h2a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1-.75-.75Z" /><path d="M6 6.5a.75.75 0 0 0 0 1.5h8a.75.75 0 0 0 0-1.5H6Z" /><path d="M6 12.5a.75.75 0 0 0 0 1.5h8a.75.75 0 0 0 0-1.5H6Z" /></svg>
      <span>POS</span>
    </button>
    <button data-key="sales">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3.5A1.5 1.5 0 0 1 4.5 2h6.879a1.5 1.5 0 0 1 1.06.44l4.122 4.12A1.5 1.5 0 0 1 17 7.622V16.5A1.5 1.5 0 0 1 15.5 18h-11A1.5 1.5 0 0 1 3 16.5v-13ZM11.5 2.5v4h4L11.5 2.5Z" /></svg>
      <span>Sales</span>
    </button>
    <button data-key="purchasing">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M1 5.25A2.25 2.25 0 0 1 3.25 3h13.5A2.25 2.25 0 0 1 19 5.25v9.5A2.25 2.25 0 0 1 16.75 17H3.25A2.25 2.25 0 0 1 1 14.75v-9.5Zm1.75-.25a.75.75 0 0 0-.75.75v9.5c0 .414.336.75.75.75h13.5a.75.75 0 0 0 .75-.75v-9.5a.75.75 0 0 0-.75-.75H2.75Z" /><path d="M9 8.25a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5h-3a.75.75 0 0 1-.75-.75ZM9 11.25a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5h-3a.75.75 0 0 1-.75-.75ZM7 8.25a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75ZM7 11.25a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75Z" /></svg>
      <span>Purchasing</span>
    </button>
    <button data-key="inventory">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-1.1.26-1.99.833-2.7 1.517C2.52 6.417 2 7.444 2 8.571V13.5A2.5 2.5 0 0 0 4.5 16h11a2.5 2.5 0 0 0 2.5-2.5V8.571c0-1.127-.52-2.154-1.3-2.861-.71-.684-1.6-1.257-2.7-1.517v-.443A2.75 2.75 0 0 0 11.25 1h-2.5ZM7.5 3.75c0-.69.56-1.25 1.25-1.25h2.5c.69 0 1.25.56 1.25 1.25v.443c-.577.13-1.12.33-1.62.581a.75.75 0 0 1-.66 0c-.5-.251-1.043-.45-1.62-.581v-.443Z" clip-rule="evenodd" /></svg>
      <span>Inventory</span>
    </button>
    <button data-key="manufacturing">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" /><path fill-rule="evenodd" d="M8.25 2a.75.75 0 0 1 .75.75v.5a.75.75 0 0 1-1.5 0v-.5a.75.75 0 0 1 .75-.75ZM11 2.25a.75.75 0 0 0-1.5 0v.5a.75.75 0 0 0 1.5 0v-.5ZM2 8.25a.75.75 0 0 1 .75-.75h.5a.75.75 0 0 1 0 1.5h-.5a.75.75 0 0 1-.75-.75ZM2.25 11a.75.75 0 0 0 0 1.5h.5a.75.75 0 0 0 0-1.5h-.5ZM8.25 17a.75.75 0 0 1 .75.75v.5a.75.75 0 0 1-1.5 0v-.5a.75.75 0 0 1 .75-.75ZM11 17.25a.75.75 0 0 0-1.5 0v.5a.75.75 0 0 0 1.5 0v-.5ZM17 8.25a.75.75 0 0 1 .75-.75h.5a.75.75 0 0 1 0 1.5h-.5a.75.75 0 0 1-.75-.75ZM17.25 11a.75.75 0 0 0 0 1.5h.5a.75.75 0 0 0 0-1.5h-.5Z" clip-rule="evenodd" /></svg>
      <span>Manufacturing</span>
    </button>
    <button data-key="accounting">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 4.25A2.25 2.25 0 0 1 4.25 2h11.5A2.25 2.25 0 0 1 18 4.25v11.5A2.25 2.25 0 0 1 15.75 18H4.25A2.25 2.25 0 0 1 2 15.75V4.25ZM4.25 3.5a.75.75 0 0 0-.75.75v11.5c0 .414.336.75.75.75h11.5a.75.75 0 0 0 .75-.75V4.25a.75.75 0 0 0-.75-.75H4.25Z" clip-rule="evenodd" /><path d="M7.502 14.13a.75.75 0 0 1-1.21-.862l2.5-4a.75.75 0 0 1 1.416.004l2.5 5a.75.75 0 0 1-1.21.862L10 12.811l-2.498 1.319Z" /></svg>
      <span>Accounting</span>
    </button>
    <button data-key="hr">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM3.465 14.493a1.23 1.23 0 0 0 .41 1.412A9.957 9.957 0 0 0 10 18c2.31 0 4.438-.784 6.131-2.095a1.23 1.23 0 0 0 .41-1.412A9.957 9.957 0 0 0 10 12c-2.31 0-4.438.784-6.131 2.095Z" /></svg>
      <span>HR</span>
    </button>
    <button data-key="crm">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3 4a2 2 0 0 0-2 2v1.161l8.441 4.221a1.25 1.25 0 0 0 1.118 0L19 7.162V6a2 2 0 0 0-2-2H3Z" /><path d="M19 8.839l-7.77 3.885a2.75 2.75 0 0 1-2.46 0L1 8.839V14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8.839Z" /></svg>
      <span>CRM</span>
    </button>
    <button data-key="reports">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.94 4.06a.75.75 0 0 1 0 1.06l-1.349 1.348a.75.75 0 0 1-1.275-.31V4.5a.75.75 0 0 1 .75-.75h3.5a.75.75 0 0 1 .325 1.31l-1.951.95Z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M4.06 15.94a.75.75 0 0 1 0-1.06l1.349-1.348a.75.75 0 0 1 1.275.31V15.5a.75.75 0 0 1-.75.75h-3.5a.75.75 0 0 1-.325-1.31l1.951-.95Z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M10 3a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5A.75.75 0 0 1 10 3ZM10 14a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5A.75.75 0 0 1 10 14ZM15.94 15.94a.75.75 0 0 1-1.06 0l-1.348-1.349a.75.75 0 0 1 .31-1.275H15.5a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.31.325l-.95-1.951Z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M4.06 4.06a.75.75 0 0 1 1.06 0l1.348 1.349a.75.75 0 0 1-.31 1.275H4.5a.75.75 0 0 1-.75-.75v-3.5a.75.75 0 0 1 1.31-.325l.95 1.951Z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M3 10a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 0 1.5h-1.5A.75.75 0 0 1 3 10Zm11.5.75a.75.75 0 0 0 0-1.5h-1.5a.75.75 0 0 0 0 1.5h1.5Z" clip-rule="evenodd" /></svg>
      <span>Reports</span>
    </button>
    <button data-key="user_management">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 9a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM6 8a2 2 0 1 1-4 0 2 2 0 0 1 4 0ZM1.49 15.326a.78.78 0 0 1-.358-.442 3 3 0 0 1 4.308-3.516 6.484 6.484 0 0 0-1.905 3.959c-.023.222-.014.442.025.654a4.97 4.97 0 0 1-2.07-.655ZM16.44 15.95a.78.78 0 0 0 .358-.442 3 3 0 0 0-4.308-3.517 6.484 6.484 0 0 1 1.905 3.96 4.97 4.97 0 0 0 2.07-.656Z" /><path d="M10 12.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Zm.354-5.854a.75.75 0 0 0-1.06-1.06l-1.5 1.5a.75.75 0 0 0 0 1.06l1.5 1.5a.75.75 0 1 0 1.06-1.06L9.22 10l1.135-1.135Z" /></svg>
      <span>User Management</span>
    </button>
    <button data-key="module_management" id="moduleManagementBtn" style="display: none;">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a.75.75 0 0 1 .75.75v.518a2.5 2.5 0 0 1 2.385 2.385h.518a.75.75 0 0 1 0 1.5h-.518a2.5 2.5 0 0 1-2.385 2.385v.518a.75.75 0 0 1-1.5 0v-.518a2.5 2.5 0 0 1-2.385-2.385H4.25a.75.75 0 0 1 0-1.5h.518A2.5 2.5 0 0 1 7.153 5.153V4.25a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 .75.75v.518a2.5 2.5 0 0 1 2.385 2.385h.518a.75.75 0 0 1 0 1.5h-.518a2.5 2.5 0 0 1-2.385 2.385v.518a.75.75 0 0 1-1.5 0v-.518a2.5 2.5 0 0 1-2.385-2.385H4.25a.75.75 0 0 1 0-1.5h.518A2.5 2.5 0 0 1 7.153 5.153V4.25a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 .75-.75v.518a2.5 2.5 0 0 1 2.385 2.385h.518a.75.75 0 0 1 0 1.5h-.518a2.5 2.5 0 0 1-2.385 2.385v.518a.75.75 0 0 1-1.5 0v-.518a2.5 2.5 0 0 1-2.385-2.385H4.25a.75.75 0 0 1 0-1.5h.518A2.5 2.5 0 0 1 7.153 5.153V4.25a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" /></svg>
      <span>Module Management</span>
    </button>
    <button data-key="settings">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 0 1-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 0 1 .947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 0 1 2.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 0 1 2.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 0 1-.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 0 1-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 0 1-2.287-.947ZM10 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" clip-rule="evenodd" /></svg>
      <span>Settings</span>
    </button>
  </nav>

  <div class="spacer"></div>
  <div class="footer">ERP System v1.0</div>
</aside>

<main class="content" role="main">
<div class="content-header">
  <button id="sidebarToggleBtn" class="sidebar-toggle-btn" title="Toggle sidebar">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
  </button>
  <div class="page-title">
    <h2 id="pageTitle">Dashboard</h2>
    <div class="page-sub" id="pageSub">Key metrics and overview</div>
  </div>
  <div class="user-menu dropdown">
    <button class="user-menu-trigger">
      <div id="userAvatar" class="user-avatar">U</div>
      <span id="userName">User</span>
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
    </button>
    <div class="dropdown-content">
      <div style="padding: 12px 16px; border-bottom: 1px solid var(--border);">
        <div id="userNameDropdown" style="font-weight: 600;">User</div><div id="userRole" style="font-size: 12px; color: var(--muted);">loading...</div></div>
      <a href="#" id="signOutBtn">Sign out</a>
    </div>
  </div>
</div>

<div style="position: relative;">
  <div class="page-loader-container" id="pageLoader">
    <div class="page-loader"></div>
  </div>
  <section id="pageContent">
    <!-- Page content will be injected here -->
  </section>
</div>
</main>
</div>

<div id="appModal" class="modal-backdrop">
  <div class="modal-content">
    <div class="modal-header">
      <h4 id="modalTitle">Modal Title</h4>
    </div>
    <div id="modalBody" class="modal-body">
      <!-- Modal content goes here -->
    </div>
    <div class="modal-footer">
      <button id="modalCloseBtn" style="background: var(--muted);">Cancel</button>
      <button id="modalSaveBtn">Save</button>
    </div>
  </div>
</div>

<div id="toastContainer" class="toast-container">
  <!-- Toasts will be dynamically added here -->
</div>

<div id="mobileMenuOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999; display: none;">
  <!-- This overlay will be shown when the mobile menu is open -->
</div>

<div id="loginScreen" class="login-screen">
  <div class="login-box">
    <div class="login-avatar">E</div>
    <h2>ERP System</h2>
    <div id="loginError" class="login-error"></div>
    <div class="input-group">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M1.5 4.5a3 3 0 0 1 3-3h15a3 3 0 0 1 3 3v15a3 3 0 0 1-3 3h-15a3 3 0 0 1-3-3v-15Zm3-1.5a1.5 1.5 0 0 0-1.5 1.5v1.281l8.41 5.607a.75.75 0 0 0 .822-.001l8.268-5.512v-1.375a1.5 1.5 0 0 0-1.5-1.5h-15Z M21 6.828l-8.268 5.512a2.25 2.25 0 0 1-2.463 0l-8.269-5.512v12.672a1.5 1.5 0 0 0 1.5 1.5h15a1.5 1.5 0 0 0 1.5-1.5v-12.672Z"></path></svg>
      <input type="email" id="emailInput" placeholder="Email" aria-label="Email">
    </div>
    <div class="input-group">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M12 1.5a5.25 5.25 0 0 0-5.25 5.25v3a3 3 0 0 0-3 3v6.75a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3v-6.75a3 3 0 0 0-3-3v-3c0-2.9-2.35-5.25-5.25-5.25Zm3.75 8.25v-3a3.75 3.75 0 1 0-7.5 0v3h7.5Z" clip-rule="evenodd"></path></svg>
      <input type="password" id="passwordInput" placeholder="Password" aria-label="Password">
    </div>
    <button id="signInBtn">Sign in</button>
  </div>
</div>

<!-- Page Templates -->
<template id="template-dashboard">
  <div class="infolet-strip">
    <div class="card infolet clickable" data-action="navigate" data-page="sales">
      <div class="infolet-icon" style="background: #0d6efd;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3.5A1.5 1.5 0 0 1 4.5 2h6.879a1.5 1.5 0 0 1 1.06.44l4.122 4.12A1.5 1.5 0 0 1 17 7.622V16.5A1.5 1.5 0 0 1 15.5 18h-11A1.5 1.5 0 0 1 3 16.5v-13ZM11.5 2.5v4h4L11.5 2.5Z" /></svg></div>
      <div><h3>Sales (30d)</h3><p id="db-total-sales" class="report-metric">Loading...</p><span id="db-sales-sub" class="indicator"></span></div>
    </div>
    <div class="card infolet clickable" data-action="navigate" data-page="sales">
      <div class="infolet-icon" style="background: #6f42c1;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M1 5.25A2.25 2.25 0 0 1 3.25 3h13.5A2.25 2.25 0 0 1 19 5.25v9.5A2.25 2.25 0 0 1 16.75 17H3.25A2.25 2.25 0 0 1 1 14.75v-9.5Zm1.75-.25a.75.75 0 0 0-.75.75v9.5c0 .414.336.75.75.75h13.5a.75.75 0 0 0 .75-.75v-9.5a.75.75 0 0 0-.75-.75H2.75Z" /><path d="M9 8.25a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5h-3a.75.75 0 0 1-.75-.75ZM9 11.25a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5h-3a.75.75 0 0 1-.75-.75ZM7 8.25a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75ZM7 11.25a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75Z" /></svg></div>
      <div><h3>Open Orders</h3><p id="db-open-orders" class="report-metric">Loading...</p><span id="db-orders-sub" class="indicator"></span></div>
    </div>
    <div class="card infolet clickable" data-action="navigate" data-page="inventory">
      <div class="infolet-icon" style="background: #fd7e14;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-1.1.26-1.99.833-2.7 1.517C2.52 6.417 2 7.444 2 8.571V13.5A2.5 2.5 0 0 0 4.5 16h11a2.5 2.5 0 0 0 2.5-2.5V8.571c0-1.127-.52-2.154-1.3-2.861-.71-.684-1.6-1.257-2.7-1.517v-.443A2.75 2.75 0 0 0 11.25 1h-2.5ZM7.5 3.75c0-.69.56-1.25 1.25-1.25h2.5c.69 0 1.25.56 1.25 1.25v.443c-.577.13-1.12.33-1.62.581a.75.75 0 0 1-.66 0c-.5-.251-1.043-.45-1.62-.581v-.443Z" clip-rule="evenodd" /></svg></div>
      <div><h3>Inventory Alerts</h3><p id="db-inventory-alerts" class="report-metric">Loading...</p><span id="db-inventory-sub" class="indicator"></span></div>
    </div>
    <div class="card infolet clickable" data-action="navigate" data-page="hr">
      <div class="infolet-icon" style="background: #d63384;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM3.465 14.493a1.23 1.23 0 0 0 .41 1.412A9.957 9.957 0 0 0 10 18c2.31 0 4.438-.784 6.131-2.095a1.23 1.23 0 0 0 .41-1.412A9.957 9.957 0 0 0 10 12c-2.31 0-4.438.784-6.131 2.095Z" /></svg></div>
      <div><h3>Employees</h3><p id="db-employees" class="report-metric">Loading...</p><span id="db-employees-sub" class="indicator"></span></div>
    </div>
  </div>
  <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); margin-top: 24px;">
    <div class="card">
      <h3 style="margin-bottom: 16px;">Monthly Sales</h3>
      <div style="position: relative; height:250px">
        <canvas id="salesChart"></canvas>
      </div>
    </div>
    <div class="card">
      <h3 style="margin-bottom: 16px;">Top Products by Stock</h3>
      <div style="position: relative; height:250px">
        <canvas id="inventoryChart"></canvas>
      </div>
    </div>
  </div>
</template>

<template id="template-sales">
  <div class="tab-nav" id="sales-tab-nav">
    <button class="tab-button active" data-tab="overview">Overview</button>
    <button class="tab-button" data-tab="orders">Orders</button>
    <button class="tab-button" data-tab="customers">Customers</button>
  </div>
  <div id="sales-tab-content">
    <div class="tab-content active" id="tab-overview">
      <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
        <div class="card"><h3>Revenue (30d)</h3><p id="sales-metric-revenue" class="report-metric"></p><span id="sales-metric-revenue-sub" class="indicator"></span></div>
        <div class="card"><h3>Gross Profit (30d)</h3><p id="sales-metric-profit" class="report-metric"></p><span id="sales-metric-profit-sub" class="indicator"></span></div>
        <div class="card"><h3>New Orders (30d)</h3><p id="sales-metric-orders" class="report-metric"></p><span id="sales-metric-orders-sub" class="indicator"></span></div>
        <div class="card"><h3>Avg. Order Value</h3><p id="sales-metric-avg" class="report-metric"></p><span id="sales-metric-avg-sub" class="indicator"></span></div>
        <div class="card"><h3>Pending Shipments</h3><p id="sales-metric-pending" class="report-metric"></p></div>
        <div class="card"><h3>Items Sold (Today)</h3><p id="sales-metric-items-today" class="report-metric"></p></div>
        <div class="card"><h3>Items Sold (This Week)</h3><p id="sales-metric-items-week" class="report-metric"></p></div>
        <div class="card"><h3>Items Sold (This Month)</h3><p id="sales-metric-items-month" class="report-metric"></p></div>
      </div>
      <div class="grid" style="grid-template-columns: 1fr 1fr; margin-top: 24px; align-items: flex-start;">
        <div class="card">
          <h3 style="margin-bottom: 16px;">Daily Sales Trend (30d)</h3>
          <div style="position: relative; height:280px"><canvas id="dailySalesChart"></canvas></div>
        </div>
        <div class="card">
          <h3 style="margin-bottom: 16px;">Top Customers (by Revenue)</h3>
          <div style="position: relative; height:280px"><canvas id="topCustomersChart"></canvas></div>
        </div>
      </div>
    </div>
    <div class="tab-content" id="tab-orders" style="display:none;">
      <div class="card" style="padding: 0;">
        <div class="table-controls">
          <h4>All Sales Orders</h4>
          <div class="actions-group">
            <select id="salesStatusFilter" class="top-search" style="padding-right: 24px;"><option value="all">All Statuses</option><option value="pending">Pending</option><option value="processing">Processing</option><option value="shipped">Shipped</option><option value="completed">Completed</option><option value="cancelled">Cancelled</option></select>
            <button onclick="showToast('New Order form to be implemented.', 'info')">New Order</button>
          </div>
        </div>
        <div style="padding: 12px; max-height: 65vh; overflow-y: auto;"><table class="data-table"><thead><tr><th>Order ID</th><th>Customer</th><th>Date</th><th>Status</th><th>Amount</th><th>Actions</th></tr></thead><tbody id="salesTableBody"></tbody></table></div>
      </div>
    </div>
    <div class="tab-content" id="tab-customers" style="display:none;">
      <div class="card" style="padding:0;"><div class="table-controls"><h4>All Customers</h4></div><div style="padding: 12px;"><table class="data-table"><thead><tr><th>Name</th><th>Email</th><th>Total Orders</th><th>Total Spend</th></tr></thead><tbody id="salesCustomersTableBody"></tbody></table></div></div>
    </div>
  </div>
</template>

<template id="template-purchasing">
  <div class="infolet-strip">
    <div class="card"><h3>Open POs</h3><p id="po-metric-open" class="report-metric"></p></div>
    <div class="card"><h3>Overdue POs</h3><p id="po-metric-overdue" class="report-metric"></p></div>
    <div class="card"><h3>Total Spend (YTD)</h3><p id="po-metric-spend" class="report-metric"></p></div>
    <div class="card"><h3>Active Suppliers</h3><p id="po-metric-suppliers" class="report-metric"></p></div>
  </div>
  <div class="card" style="margin-top: 24px; padding: 0;">
    <div class="table-controls">
      <div class="tab-nav" id="po-tab-nav" style="margin:0; border:0;">
        <button class="tab-button active" data-tab="po">Purchase Orders</button>
        <button class="tab-button" data-tab="suppliers">Suppliers</button>
      </div>
        <button onclick="showToast('New PO form to be implemented.', 'info')">New Purchase Order</button>
    </div>
    <div id="po-tab-content" style="padding: 12px;">
      <div class="tab-content active" id="tab-po"><table class="data-table"><thead><tr><th>PO ID</th><th>Supplier</th><th>Order Date</th><th>Status</th><th>Total</th></tr></thead><tbody id="purchaseOrdersTableBody"></tbody></table></div>
      <div class="tab-content" id="tab-suppliers" style="display:none;"><table class="data-table"><thead><tr><th>Name</th><th>Contact</th><th>Email</th><th>Phone</th></tr></thead><tbody id="suppliersTableBody"></tbody></table></div>
    </div>
  </div>
</template>

<template id="template-inventory">
  <div class="infolet-strip" style="padding-bottom: 0;">
    <div class="card infolet">
      <div class="infolet-icon" style="background: #198754;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a.75.75 0 0 1 .75.75v.085a.75.75 0 0 1-1.5 0V2.75A.75.75 0 0 1 10 2Zm3.536 2.464a.75.75 0 0 1 1.06 0l.001.001a.75.75 0 0 1 0 1.06l-.001.001a.75.75 0 0 1-1.06 0l-1.59-1.59a.75.75 0 0 1 0-1.061l1.59-1.59a.75.75 0 0 1 1.06 0l.001.001a.75.75 0 0 1 0 1.06l-1.59 1.59ZM4.929 3.525a.75.75 0 0 1 0 1.06l-1.59 1.59a.75.75 0 0 1-1.06-1.06l.001-.001a.75.75 0 0 1 1.06 0l1.59 1.59Zm7.607 11.95a.75.75 0 0 1 0 1.06l-1.59 1.59a.75.75 0 0 1-1.06 0l-.001-.001a.75.75 0 0 1 0-1.06l1.59-1.59a.75.75 0 0 1 1.06 0Zm-9.192 0a.75.75 0 0 1 1.06 0l1.59 1.59a.75.75 0 0 1 0 1.06l-.001.001a.75.75 0 0 1-1.06 0l-1.59-1.59a.75.75 0 0 1 0-1.06ZM10 6.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7Z" /></svg></div>
      <div><h3>Stock Value</h3><p id="inv-metric-value" class="report-metric">Loading...</p></div>
    </div>
    <div class="card infolet">
      <div class="infolet-icon" style="background: #fd7e14;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-1.1.26-1.99.833-2.7 1.517C2.52 6.417 2 7.444 2 8.571V13.5A2.5 2.5 0 0 0 4.5 16h11a2.5 2.5 0 0 0 2.5-2.5V8.571c0-1.127-.52-2.154-1.3-2.861-.71-.684-1.6-1.257-2.7-1.517v-.443A2.75 2.75 0 0 0 11.25 1h-2.5ZM7.5 3.75c0-.69.56-1.25 1.25-1.25h2.5c.69 0 1.25.56 1.25 1.25v.443c-.577.13-1.12.33-1.62.581a.75.75 0 0 1-.66 0c-.5-.251-1.043-.45-1.62-.581v-.443Z" clip-rule="evenodd" /></svg></div>
      <div><h3>Low Stock Items</h3><p id="inv-metric-low" class="report-metric">Loading...</p></div>
    </div>
    <div class="card infolet">
      <div class="infolet-icon" style="background: #dc3545;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-1.1.26-1.99.833-2.7 1.517C2.52 6.417 2 7.444 2 8.571V13.5A2.5 2.5 0 0 0 4.5 16h11a2.5 2.5 0 0 0 2.5-2.5V8.571c0-1.127-.52-2.154-1.3-2.861-.71-.684-1.6-1.257-2.7-1.517v-.443A2.75 2.75 0 0 0 11.25 1h-2.5ZM7.5 3.75c0-.69.56-1.25 1.25-1.25h2.5c.69 0 1.25.56 1.25 1.25v.443c-.577.13-1.12.33-1.62.581a.75.75 0 0 1-.66 0c-.5-.251-1.043-.45-1.62-.581v-.443Z" clip-rule="evenodd" /></svg></div>
      <div><h3>Out of Stock</h3><p id="inv-metric-out" class="report-metric">Loading...</p></div>
    </div>
    <div class="card infolet">
      <div class="infolet-icon" style="background: #6f42c1;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.5 3A2.5 2.5 0 0 0 3 5.5v2.879a.75.75 0 0 0 .22.53l6.101 6.1a.75.75 0 0 0 1.06 0l6.1-6.1a.75.75 0 0 0 .22-.53V5.5A2.5 2.5 0 0 0 14.5 3h-9Z" /><path d="M12.5 6a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" /></svg></div>
      <div><h3>Total SKUs</h3><p id="inv-metric-skus" class="report-metric">Loading...</p></div>
    </div>
  </div>
  <div class="card" style="margin-top: 24px; padding: 0;">
    <div class="table-controls">
      <h4>Product Inventory</h4>
      <div class="actions-group">
        <input id="inventorySearch" placeholder="Search by name or SKU..." class="top-search" style="width: 200px;">
        <select id="inventoryCategoryFilter" class="top-search" style="padding-right: 24px;"><option value="all">All Categories</option></select>
        <select id="inventoryStockFilter" class="top-search" style="padding-right: 24px;"><option value="all">All Stock</option><option value="in_stock">In Stock</option><option value="low_stock">Low Stock</option><option value="out_of_stock">Out of Stock</option></select>
        <button data-action="open-product-modal">Add Product</button>
      </div>
    </div>
    <div style="padding: 12px; max-height: 65vh; overflow-y: auto;">
      <table class="data-table"><thead><tr><th>SKU</th><th>Name</th><th>Category</th><th>Price</th><th>Cost</th><th>Stock</th><th>Stock Value</th><th>Actions</th></tr></thead><tbody id="inventoryTableBody"></tbody></table>
    </div>
  </div>
</template>

<template id="template-manufacturing">
  <div class="grid">
    <div class="card"><h3>Active Orders</h3><p id="mfg-metric-active" style="font-size: 20px; font-weight: 600;">Loading...</p></div>
    <div class="card"><h3>Pending Orders</h3><p id="mfg-metric-pending" style="font-size: 20px; font-weight: 600;">Loading...</p></div>
    <div class="card"><h3>Completed (24h)</h3><p id="mfg-metric-completed" style="font-size: 20px; font-weight: 600;">Loading...</p></div>
    <div class="card"><h3>Material Shortages</h3><p id="mfg-metric-shortages" style="font-size: 20px; font-weight: 600;">Loading...</p></div>
  </div>
  <div class="grid" style="grid-template-columns: 1fr 2fr; margin-top: 24px;">
    <div class="card">
      <h3 style="margin-bottom: 16px;">Production Status</h3>
      <div style="position: relative; height:280px">
        <canvas id="productionStatusChart"></canvas>
      </div>
    </div>
    <div class="card" style="padding:0;">
      <div class="table-controls">
        <div class="tab-nav" id="mfg-tab-nav" style="margin:0; border:0;">
          <button class="tab-button active" data-tab="orders">Production Orders</button>
          <button class="tab-button" data-tab="bom">Bill of Materials</button>
        </div>
        <button onclick="showToast('New Production Order form to be implemented.', 'info')">New Order</button>
      </div>
      <div id="mfg-tab-content" style="padding: 12px;">
        <div class="tab-content active" id="tab-orders"><table class="data-table"><thead><tr><th>Order ID</th><th>Product</th><th>Quantity</th><th>Status</th><th>Due Date</th></tr></thead><tbody id="productionOrdersTableBody"></tbody></table></div>
        <div class="tab-content" id="tab-bom" style="display:none;"><table class="data-table"><thead><tr><th>Product</th><th>Component</th><th>Quantity per Unit</th></tr></thead><tbody id="bomTableBody"></tbody></table></div>
      </div>
    </div>
  </div>
</template>

<template id="template-accounting">
  <div class="grid">
    <div class="card"><h3>Total Assets</h3><p id="acct-metric-assets" style="font-size: 20px; font-weight: 600;">Loading...</p></div>
    <div class="card"><h3>Liabilities & Equity</h3><p id="acct-metric-liabilities" style="font-size: 20px; font-weight: 600;">Loading...</p></div>
    <div class="card"><h3>Net Income (YTD)</h3><p id="acct-metric-net-income" style="font-size: 20px; font-weight: 600;">Loading...</p></div>
    <div class="card"><h3>Accounts Receivable</h3><p id="acct-metric-ar" style="font-size: 20px; font-weight: 600;">Loading...</p></div>
  </div>
  <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); margin-top: 24px;">
    <div class="card">
      <h3 style="margin-bottom: 16px;">Financial Position</h3>
      <div style="position: relative; height:280px">
        <canvas id="financialPositionChart"></canvas>
      </div>
    </div>
    <div class="card" style="padding:0;">
      <div class="table-controls">
        <div class="tab-nav" id="accounting-tab-nav" style="margin:0; border:0;">
          <button class="tab-button active" data-tab="accounts">Chart of Accounts</button>
          <button class="tab-button" data-tab="journals">Journal Entries</button>
        </div>
        <button onclick="showToast('Add new entry form to be implemented.', 'info')">Add Entry</button>
      </div>
      <div id="accounting-tab-content" style="padding: 12px;">
        <div class="tab-content active" id="tab-accounts"><table class="data-table"><thead><tr><th>Account #</th><th>Name</th><th>Type</th><th>Balance</th></tr></thead><tbody id="chartOfAccountsBody"></tbody></table></div>
        <div class="tab-content" id="tab-journals" style="display:none;"><table class="data-table"><thead><tr><th>Date</th><th>Entry</th><th>Debit</th><th>Credit</th></tr></thead><tbody id="journalEntriesBody"></tbody></table></div>
      </div>
    </div>
  </div>
</template>

<template id="template-hr">
  <div class="grid">
    <div class="card"><h3>Total Employees</h3><p id="hr-metric-total" style="font-size: 20px; font-weight: 600;">Loading...</p></div>
    <div class="card"><h3>New Hires (30d)</h3><p id="hr-metric-new" style="font-size: 20px; font-weight: 600;">Loading...</p></div>
    <div class="card"><h3>Departments</h3><p id="hr-metric-depts" style="font-size: 20px; font-weight: 600;">Loading...</p></div>
    <div class="card"><h3>Avg. Tenure</h3><p id="hr-metric-tenure" style="font-size: 20px; font-weight: 600;">Loading...</p></div>
  </div>
  <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); margin-top: 24px;">
    <div class="card">
      <h3 style="margin-bottom: 16px;">Employees by Department</h3>
      <div style="position: relative; height:280px"><canvas id="departmentChart"></canvas></div>
    </div>
    <div class="card">
      <h3 style="margin-bottom: 16px;">Recent Hires</h3>
      <div id="hr-recent-hires-list">Loading...</div>
    </div>
  </div>
  <div class="card" style="margin-top: 24px; padding: 0;">
    <div class="table-controls">
      <h4>All Employees</h4>
      <button onclick="showToast('Add Employee form to be implemented.', 'info')">Add Employee</button>
    </div>
    <div style="padding: 12px;"><table class="data-table"><thead><tr><th>Name</th><th>Position</th><th>Department</th><th>Email</th><th>Hire Date</th></tr></thead><tbody id="employeesTableBody"></tbody></table></div>
  </div>
</template>

<template id="template-crm">
  <div class="grid">
    <div class="card"><h3>New Leads (30d)</h3><p id="crm-metric-leads" style="font-size: 20px; font-weight: 600;">Loading...</p></div>
    <div class="card"><h3>Pipeline Value</h3><p id="crm-metric-pipeline" style="font-size: 20px; font-weight: 600;">Loading...</p></div>
    <div class="card"><h3>Conversion Rate</h3><p id="crm-metric-conversion" style="font-size: 20px; font-weight: 600;">Loading...</p></div>
    <div class="card"><h3>New Customers (30d)</h3><p id="crm-metric-customers" style="font-size: 20px; font-weight: 600;">Loading...</p></div>
  </div>

  <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); margin-top: 24px;">
    <div class="card">
      <h3 style="margin-bottom: 16px;">Opportunities by Stage</h3>
      <div style="position: relative; height:280px">
        <canvas id="opportunityStageChart"></canvas>
      </div>
    </div>
    <div class="card">
      <h3 style="margin-bottom: 16px;">Recent Leads</h3>
      <div id="crm-recent-leads-list">Loading...</div>
    </div>
  </div>

  <div class="card" style="margin-top: 24px; padding: 0;">
    <div class="table-controls">
      <h4>All Records</h4>
      <div class="actions">
        <div class="tab-nav" style="margin:0; border:0;">
          <button class="tab-button active" data-tab="opportunities">Opportunities</button>
          <button class="tab-button" data-tab="leads">Leads</button>
          <button class="tab-button" data-tab="customers">Customers</button>
        </div>
        <button onclick="showToast('Add new item form to be implemented.', 'info')">Add New</button>
      </div>
    </div>
    <div id="crm-tab-content" style="padding: 12px;">
      <div class="tab-content active" id="tab-opportunities">
        <table class="data-table"><thead><tr><th>Opportunity Name</th><th>Customer</th><th>Stage</th><th>Value</th><th>Close Date</th></tr></thead><tbody id="opportunitiesTableBody"></tbody></table>
      </div>
      <div class="tab-content" id="tab-leads" style="display:none;">
        <table class="data-table"><thead><tr><th>Name</th><th>Company</th><th>Email</th><th>Status</th><th>Source</th></tr></thead><tbody id="leadsTableBody"></tbody></table>
      </div>
      <div class="tab-content" id="tab-customers" style="display:none;">
        <table class="data-table"><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Address</th></tr></thead><tbody id="customersTableBody"></tbody></table>
      </div>
    </div>
  </div>
</template>

<template id="template-reports">
  <div class="card" style="margin-bottom: 24px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div style="display: flex; align-items: center; gap: 16px;">
        <label for="reportDateRange" style="font-size: 14px; font-weight: 500;">Date Range:</label>
        <select id="reportDateRange" style="padding: 8px 12px; border-radius: 8px;">
          <option value="30">Last 30 Days</option>
          <option value="90">Last 90 Days</option>
          <option value="365">Last 365 Days</option>
          <option value="ytd">Year to Date</option>
        </select>
      </div>
      <div class="actions-group">
        <button id="printReportBtn">Print</button>
        <div class="dropdown">
          <button id="exportReportBtn">Export</button>
          <div class="dropdown-content"><a href="#" data-format="pdf">as PDF</a><a href="#" data-format="excel">as Excel (CSV)</a><a href="#" data-format="csv">as CSV</a></div>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-nav" id="reports-tab-nav">
    <button class="tab-button active" data-tab="sales">Sales</button>
    <button class="tab-button" data-tab="financial">Financial</button>
    <button class="tab-button" data-tab="inventory">Inventory</button>
    <button class="tab-button" data-tab="hr">HR</button>
  </div>

  <div id="reports-tab-content">
    <div class="tab-content active" id="tab-sales">
      <div class="grid"><div class="card"><h3>Revenue</h3><p id="report-sales-revenue" class="report-metric">Loading...</p></div><div class="card"><h3>Orders</h3><p id="report-sales-orders" class="report-metric">Loading...</p></div><div class="card"><h3>Avg. Order Value</h3><p id="report-sales-avg" class="report-metric">Loading...</p></div></div>
      <div class="card" style="margin-top: 24px;"><h3 style="margin-bottom:16px;">Revenue vs Profit</h3><div style="position: relative; height:280px"><canvas id="reportSalesChart"></canvas></div></div>
    </div>
    <div class="tab-content" id="tab-financial" style="display:none;">
      <div class="grid"><div class="card"><h3>Net Income</h3><p id="report-fin-net" class="report-metric">Loading...</p></div><div class="card"><h3>Gross Margin</h3><p id="report-fin-margin" class="report-metric">Loading...</p></div><div class="card"><h3>Total Expenses</h3><p id="report-fin-expenses" class="report-metric">Loading...</p></div></div>
      <div class="card" style="margin-top: 24px;"><h3 style="margin-bottom:16px;">Income vs Expenses</h3><div style="position: relative; height:280px"><canvas id="reportFinancialChart"></canvas></div></div>
    </div>
    <div class="tab-content" id="tab-inventory" style="display:none;">
      <div class="grid"><div class="card"><h3>Stock Value</h3><p id="report-inv-value" class="report-metric">Loading...</p></div><div class="card"><h3>Turnover Rate</h3><p id="report-inv-turnover" class="report-metric">Loading...</p></div><div class="card"><h3>Items Sold</h3><p id="report-inv-sold" class="report-metric">Loading...</p></div></div>
      <div class="card" style="margin-top: 24px;"><h3 style="margin-bottom:16px;">Top 10 Selling Products</h3><div style="padding:0;"><table class="data-table"><thead><tr><th>Product</th><th>Units Sold</th><th>Revenue</th></tr></thead><tbody id="reportTopProductsTable"></tbody></table></div></div>
    </div>
    <div class="tab-content" id="tab-hr" style="display:none;">
      <div class="grid"><div class="card"><h3>Headcount</h3><p id="report-hr-headcount" class="report-metric">Loading...</p></div><div class="card"><h3>New Hires</h3><p id="report-hr-new" class="report-metric">Loading...</p></div><div class="card"><h3>Turnover</h3><p id="report-hr-turnover" class="report-metric">Loading...</p></div></div>
      <div class="card" style="margin-top: 24px;"><h3 style="margin-bottom:16px;">Headcount by Department</h3><div style="position: relative; height:280px"><canvas id="reportHrChart"></canvas></div></div>
    </div>
  </div>
</template>

<template id="template-settings">
  <div class="grid">
    <div class="card">
      <h3>Preferences</h3>
      <p>Display and application settings</p>
      <div class="list">
        <div class="item">
          <div><div style="font-weight:600">Night light</div><div style="font-size:12px;color:var(--muted)">Reduces blue light</div></div>
          <div class="setting-row"><div class="toggle" data-setting="nightLight" role="switch" aria-checked="false"><div class="knob"></div></div></div>
        </div>
        <div class="item">
          <div><div style="font-weight:600">Dark mode</div><div style="font-size:12px;color:var(--muted)">Use a dark theme</div></div>
          <div class="setting-row"><div class="toggle" data-setting="darkMode" role="switch" aria-checked="false"><div class="knob"></div></div></div>
        </div>
        <div class="item">
          <div><div style="font-weight:600">Brightness</div><div style="font-size:12px;color:var(--muted)">Adjust screen brightness</div></div>
          <input type="range" data-setting="brightness" min="40" max="100" value="100" style="flex:1; margin-left: 16px;">
        </div>
        <div class="item">
          <div><div style="font-weight:600">Theme</div><div style="font-size:12px;color:var(--muted)">Change the application theme</div></div>
          <select id="themeSelector" style="padding: 6px 10px; border-radius: 6px;">
            <option value="default">Default</option>
            <option value="slate">Slate</option>
            <option value="brand">Brand</option>
          </select>
        </div>
        <div class="item">
          <div><div style="font-weight:600">Default Tax Exempt</div><div style="font-size:12px;color:var(--muted)">Apply tax exemption to new POS sales</div></div>
          <div class="setting-row"><div class="toggle" data-setting="taxExempt" role="switch" aria-checked="false"><div class="knob"></div></div></div>
        </div>
      </div>
    </div>
    <div class="card">
      <h3>Danger Zone</h3>
      <p>Irreversible system actions</p>
      <div class="list">
        <div class="item">
          <div><div style="font-weight:600">Delete All Records</div><div style="font-size:12px;color:var(--muted)">Clear all transactional data</div></div>
          <button class="action-btn danger" id="deleteAllRecordsBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>
</template>

<template id="template-user_management">
  <div class="card">
    <p style="margin:0 0 8px;">Filter users by role:</p>
    <div class="role-chip-container" id="roleFilterContainer"><p>Loading roles...</p></div>
    <div style="margin-top: 16px;">
      <table class="data-table">
        <thead><tr><th>User</th><th>Email</th><th>Roles</th><th>Department</th><th>Actions</th></tr></thead>
        <tbody id="usersTableBody"><tr><td colspan="5">Loading users...</td></tr></tbody>
      </table>
    </div>
  </div>
</template>

<template id="template-module_management">
  <div class="card" style="max-width: 800px; margin: 0 auto;">
    <h3>Available Modules</h3>
    <p>Enable or disable modules for all users. Changes will take effect on their next page load or refresh.</p>
    <div class="list" id="moduleListContainer">
      <p style="padding: 12px 14px;">Loading modules...</p>
    </div>
  </div>
</template>

<template id="template-pos">
  <div class="grid" style="grid-template-columns: 2fr 1fr; align-items: flex-start; gap: 24px;">
    <!-- Left side: Product Selection -->
    <div class="card" style="padding: 0;">
      <div class="table-controls">
        <h4>Products</h4>
        <input id="posProductSearch" placeholder="Search products..." class="top-search" style="width: 250px;">
      </div>
      <div id="posProductGrid" class="grid" style="padding: 12px; max-height: 75vh; overflow-y: auto;">
        <p>Loading products...</p>
      </div>
    </div>

    <!-- Right side: Order Summary -->
    <div class="card" style="position: sticky; top: 28px;">
      <h4>Current Order</h4>
      <div id="posOrderItems" style="min-height: 200px; max-height: 45vh; overflow-y: auto; margin: 12px 0; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); padding: 8px 0;">
        <p style="text-align: center; color: var(--muted); font-size: 13px;">No items added</p>
      </div>
      <div id="posOrderSummary" style="font-size: 14px; display: flex; flex-direction: column; gap: 4px;"></div>
      <div style="display: flex; gap: 10px; margin-top: 16px;"><button id="posPayBtn" style="flex: 1; padding: 12px; font-size: 15px;">Pay</button><button id="posSaveSaleBtn" style="background: var(--muted);">Save</button><button id="posClearBtn" style="background: var(--muted);">Clear</button></div>
    </div>

    <!-- Middle: Pending Sales -->
    <div class="card" style="grid-column: 1 / -1;">
      <h4>Pending Sales</h4>
      <div id="posPendingSales" style="margin-top: 12px;">
        <p>Loading pending sales...</p>
      </div>
    </div>

    <!-- Bottom: Recent Transactions -->
    <div class="card" style="grid-column: 1 / -1;">
      <h4>Recent Transactions</h4>
      <div id="posRecentSales" style="margin-top: 12px;">
        <p>Loading recent sales...</p>
      </div>
    </div>
  </div>
</template>

<script type="module">
const navButtons=document.querySelectorAll('#navList button');
const pageTitle=document.getElementById('pageTitle');
const pageSub=document.getElementById('pageSub');
const pageContent=document.getElementById('pageContent');
const sidebarSearch=document.getElementById('sidebarSearch');
const topSearch=document.getElementById('topSearch');
const appEl = document.querySelector('.app');
const loginScreen = document.getElementById('loginScreen');
const signInBtn = document.getElementById('signInBtn');
const signOutBtn = document.getElementById('signOutBtn');
const emailInput = document.getElementById('emailInput');
const passwordInput = document.getElementById('passwordInput');
const loginError = document.getElementById('loginError');
const userRoleEl = document.getElementById('userRole');
const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
const userName = document.getElementById('userName');
const userNameDropdown = document.getElementById('userNameDropdown');
const userAvatar = document.getElementById('userAvatar');


const formatCurrency = (value) => `$${(value || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

/**
 * Shows a toast notification.
 * @param {string} message The message to display.
 * @param {string} type 'success' (default) or 'error'.
 */
function showToast(message, type = 'success') {
  const container = document.getElementById('toastContainer');
  if (!container) return;
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  container.appendChild(toast);
  // Remove the toast from the DOM after the animation finishes
  setTimeout(() => {
    toast.remove();
  }, 3500);
}

/* Toast Notification Styles */
const toastStyles = `
.toast-container{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:10001;display:flex;flex-direction:column;align-items:center;gap:10px;}
.toast{padding:12px 18px;border-radius:8px;background:var(--panel);color:var(--text);box-shadow:var(--shadow);border:1px solid var(--border);animation:slideIn 0.3s ease, fadeOut 0.5s ease 3s forwards;}
.toast.error{background:#e53935;color:#fff;}
@keyframes slideIn{from{transform:translateY(-100%);opacity:0;}to{transform:translateY(0);opacity:1;}}
@keyframes fadeOut{from{opacity:1;}to{opacity:0;transform:translateY(-20px);}}
`;

// Inject toast styles into the head
const styleSheet = document.createElement("style");
styleSheet.type = "text/css";
styleSheet.innerText = toastStyles;
document.head.appendChild(styleSheet);


const pages={
  dashboard: { title: 'Dashboard', sub: 'Key metrics and overview' },
  sales: { title: 'Sales', sub: 'Orders, invoices, and customers' },
  purchasing: { title: 'Purchasing', sub: 'Suppliers and purchase orders' },
  inventory: { title: 'Inventory', sub: 'Stock levels and products' },
  manufacturing: { title: 'Manufacturing', sub: 'Production and BOM' },
  accounting: { title: 'Accounting', sub: 'Financial records and chart of accounts' },
  hr: { title: 'HR', sub: 'Employees and payroll' },
  crm: { title: 'CRM', sub: 'Leads and opportunities' },
  reports: { title: 'Reports', sub: 'Analytics and KPIs' },
  settings: { title: 'Settings', sub: 'System configuration and display' },
  user_management: { title: 'User Management', sub: 'Administer user accounts and roles' },
  module_management: { title: 'Module Management', sub: 'Enable or disable ERP modules' },
  pos: { title: 'Point of Sale (POS)', sub: 'Point of Sale interface' }
};

let userPreferences = { darkMode: false, nightLight: false, brightness: 100, theme: 'default', taxExempt: false };


async function updatePreference(key, value) {
    userPreferences[key] = value;
    localStorage.setItem(key, value); // Also save to localStorage for immediate FOUC prevention.

    // Map JavaScript-style keys to database-style keys
    const keyMap = {
        darkMode: 'dark_mode',
        nightLight: 'night_light',
        brightness: 'brightness',
        theme: 'theme',
        taxExempt: 'tax_exempt'
    };
    const dbKey = keyMap[key] || key;

    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    const { error } = await supabase
        .from('user_preferences')
        .upsert({ id: user.id, [dbKey]: value }, { onConflict: 'id' });

    if (error) console.error(`Error updating preference ${key}:`, error);
}
// ... (rest of the file is unchanged until the sales page definition)
function applyPreferences() {
    // Dark Mode
    document.documentElement.classList.toggle('dark-mode', userPreferences.darkMode);
    document.querySelectorAll('[data-setting="darkMode"]').forEach(toggle => {
        toggle.classList.toggle('on', userPreferences.darkMode);
        toggle.setAttribute('aria-checked', userPreferences.darkMode);
    });

    // Night Light
    document.documentElement.classList.toggle('night-light', userPreferences.nightLight);
    document.querySelectorAll('[data-setting="nightLight"]').forEach(toggle => {
        toggle.classList.toggle('on', userPreferences.nightLight);
        toggle.setAttribute('aria-checked', userPreferences.nightLight);
    });

    // Brightness
    const brightnessValue = userPreferences.brightness || 100;
    document.documentElement.style.setProperty('--brightness', brightnessValue / 100);
    document.querySelectorAll('[data-setting="brightness"]').forEach(slider => {
        slider.value = brightnessValue;
    });

    // Theme
    const theme = userPreferences.theme || 'default';
    document.documentElement.classList.toggle('theme-slate', theme === 'slate');
    document.documentElement.classList.toggle('theme-brand', theme === 'brand');
    const themeSelector = document.getElementById('themeSelector');
    if (themeSelector) {
        themeSelector.value = theme;
    }

    // Tax Exempt
    const isTaxExempt = userPreferences.taxExempt || false;
    document.querySelectorAll('[data-setting="taxExempt"]').forEach(toggle => {
        toggle.classList.toggle('on', isTaxExempt);
        toggle.setAttribute('aria-checked', isTaxExempt);
    });
    // Re-render any active charts to apply new theme colors
    if (document.getElementById('salesChart')) loadDashboardData();
}

function toggleDarkMode() {
  document.documentElement.classList.toggle('dark-mode');
  const isDarkMode = document.documentElement.classList.contains('dark-mode');
  updatePreference('darkMode', isDarkMode).then(applyPreferences);
}
function toggleNightLight() {
  document.documentElement.classList.toggle('night-light');
  const isNightLightOn = document.documentElement.classList.contains('night-light');
  updatePreference('nightLight', isNightLightOn).then(applyPreferences);
}

function toggleTaxExempt() {
  const taxExemptToggle = document.querySelector('[data-setting="taxExempt"]');
  const isTaxExempt = taxExemptToggle ? !taxExemptToggle.classList.contains('on') : false;
  updatePreference('taxExempt', isTaxExempt).then(applyPreferences);
}

function setBrightness(value) {
  updatePreference('brightness', value).then(applyPreferences);
}

const pageLoader = document.getElementById('pageLoader');

async function setActive(key){
  // Set up the page structure immediately.
  navButtons.forEach(b=>b.classList.toggle('active',b.dataset.key===key));
  pageTitle.textContent=pages[key].title;
  pageSub.textContent=pages[key].sub;
  
  const template = document.getElementById(`template-${key}`);
  if (template) {
    pageContent.innerHTML = ''; // Clear previous content
    pageContent.appendChild(template.content.cloneNode(true));
  } else {
    pageContent.innerHTML = `<div class="card"><p>Error: Page template for "${key}" not found.</p></div>`;
  }
  localStorage.setItem('lastActivePage', key); // Save the active page

  // Only show the loader if data fetching takes more than 200ms
  const loaderTimeout = setTimeout(() => {
    pageLoader.classList.add('visible');
  }, 200);

  // Define the data loading logic as a separate async operation
  const loadPageData = async () => {
    if (key === 'dashboard') await loadDashboardData();
    else if (key === 'sales') await loadSalesDashboard();
    else if (key === 'purchasing') await loadPurchasingDashboard();
    else if (key === 'inventory') await loadInventoryDashboard();
    else if (key === 'manufacturing') await loadManufacturingData();
    else if (key === 'accounting') {
      await loadAccountingDashboardData();
      loadChartOfAccountsData();
      setupAccountingTabs();
    }
    else if (key === 'hr') {
      await loadHrDashboardData();
      loadEmployeesData();
    }
    else if (key === 'crm') {
     loadCrmDashboardData();
     loadOpportunitiesData();
     setupCrmTabs();
   }
   if (key === 'reports') {
    loadReportsDashboard();
    setupReportsTabs();
   }
   if (key === 'user_management') {
     loadRolesData();
     loadUsersData();
   }
   if (key === 'module_management') {
     loadModuleManagementData();
   }
   if (key === 'pos') {
     loadPosProducts();
     loadPendingSales();
     loadPosRecentSales();
     setupPos();
   }
    else if (key === 'settings') setupSettingsActions();
  };

  // Execute the data loading and ensure the loader is handled correctly
  try {
    await loadPageData();
  } finally {
    clearTimeout(loaderTimeout); // Prevent the loader from showing if loading was fast
    attachToggleListeners();
    applyPreferences();
    pageLoader.classList.remove('visible');
  }

}

async function loadModuleManagementData() {
    const container = document.getElementById('moduleListContainer');
    if (!container) return;

    try {
        const { data: modules, error } = await fetchAndCache('modules_config', () =>
            supabase.from('modules').select('module_key, name, is_enabled').order('name')
        );

        if (error) throw error;

        if (modules && modules.length > 0) {
            container.innerHTML = modules.map(mod => {
                const isCoreModule = ['dashboard', 'settings', 'user_management', 'module_management'].includes(mod.module_key);
                return `
                    <div class="item">
                        <div>
                            <div style="font-weight:600">${mod.name}</div>
                            <div style="font-size:12px;color:var(--muted);">${mod.module_key}</div>
                        </div>
                        <div class="setting-row">
                            ${isCoreModule ? '<span style="font-size:12px; color:var(--muted);">Always Enabled</span>' : `
                            <div class="toggle ${mod.is_enabled ? 'on' : ''}" data-module-key="${mod.module_key}" role="switch" aria-checked="${mod.is_enabled}">
                                <div class="knob"></div>
                            </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');

            // Add event listeners to the new toggles
            container.querySelectorAll('.toggle').forEach(toggle => {
                toggle.addEventListener('click', async () => {
                    const moduleKey = toggle.dataset.moduleKey;
                    const newStatus = !toggle.classList.contains('on');
                    
                    // Optimistically update UI
                    toggle.classList.toggle('on', newStatus);
                    toggle.setAttribute('aria-checked', newStatus);

                    // Update database
                    const { error } = await supabase.from('modules').update({ is_enabled: newStatus }).eq('module_key', moduleKey);
                    if (error) {
                        alert(`Error updating module: ${error.message}`);
                        // Revert UI on error
                        toggle.classList.toggle('on', !newStatus);
                        toggle.setAttribute('aria-checked', !newStatus);
                    }
                });
            });
        }
    } catch (error) {
        console.error('Error loading module management data:', error);
        container.innerHTML = `<p style="padding: 12px 14px; color: #e53935;">Error loading modules.</p>`;
    }
}

// --- Caching Layer ---
const appCache = {};
const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

async function fetchAndCache(key, fetcher) {
  const cached = appCache[key];
  // If a valid, non-stale promise exists, return it
  if (cached && (Date.now() - cached.timestamp < CACHE_TTL)) {
    return cached.promise;
  }

  // Otherwise, create a new fetch promise, cache it, and return it
  const promise = fetcher();
  appCache[key] = {
    promise: promise,
    timestamp: Date.now()
  };
  return promise;
}

// --- Supabase Integration ---
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// IMPORTANT: Replace with your Supabase project URL and anon key
const supabaseUrl = 'https://dbdgkbofxksgcjctthxb.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRiZGdrYm9meGtzZ2NqY3R0aHhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5OTY1MDcsImV4cCI6MjA3NTU3MjUwN30.utbj9NN6sKUOq1RP83lQu1CbVQnvfR5uiQv3hgn_u44';
const supabase = createClient(supabaseUrl, supabaseKey);

async function signIn() {
  loginError.textContent = '';
  const { data, error } = await supabase.auth.signInWithPassword({
    email: emailInput.value,
    password: passwordInput.value,
  });

  if (error) {
    loginError.textContent = error.message;
  } else if (data.user) {
    showApp(data.user);
  }
}

async function signOut() {
  await supabase.auth.signOut();
  appEl.style.display = 'none'; // Hide the main app
  loginScreen.classList.add('visible'); // Show the login screen
}

async function showApp(user) {
  loginScreen.classList.remove('visible'); // Hide the login screen
  appEl.style.display = 'flex'; // Show the main app
  const simpleName = user.email.split('@')[0];
  userName.textContent = simpleName;
  userNameDropdown.textContent = simpleName;
  userAvatar.textContent = simpleName.charAt(0).toUpperCase();

  // Fetch profile and preferences in parallel
  const [profileRes, prefsRes, modulesRes] = await Promise.all([
    supabase
      .from('profiles')
      .select(`full_name, user_roles(roles(name))`)
      .eq('id', user.id)
      .single(),
    supabase
      .from('user_preferences')
      .select(`dark_mode, night_light, brightness, theme, tax_exempt`)
      .eq('id', user.id)
      // Do not use .single() here, as a new user may not have a preferences row yet.
    , fetchAndCache('enabled_modules', () => 
      supabase.from('modules').select('module_key').eq('is_enabled', true)
    )
  ]);

  if (prefsRes.error) console.error('Error fetching preferences:', prefsRes.error);
  if (prefsRes.data) {
    // The result is an array, even if it contains one item.
    const userPrefs = prefsRes.data[0];
    if (userPrefs) {
      userPreferences = {
          darkMode: userPrefs.dark_mode,
          nightLight: userPrefs.night_light,
          brightness: userPrefs.brightness,
          theme: userPrefs.theme || 'default',
          taxExempt: userPrefs.tax_exempt || false
      };
    }
    applyPreferences();
  }

  const profile = profileRes.data;
  if (profile) {
    if (profile.full_name) {
      userName.textContent = profile.full_name;
      userNameDropdown.textContent = profile.full_name;
      userAvatar.textContent = profile.full_name.charAt(0).toUpperCase();
    }
    const roles = profile.user_roles.map(ur => ur.roles.name);
    const userRoleEl = document.getElementById('userRole');
    if (userRoleEl) userRoleEl.textContent = roles.length > 0 ? roles.join(', ') : 'Employee';

    // Show admin-only menu items
    const moduleManagementBtn = document.getElementById('moduleManagementBtn');
    if (moduleManagementBtn && roles.includes('Admin')) {
      moduleManagementBtn.style.display = 'flex';
    }
  }

  // Apply module visibility based on fetched enabled modules
  if (modulesRes.data) {
    const enabledModules = modulesRes.data.map(m => m.module_key);
    document.querySelectorAll('#navList button').forEach(button => {
        const key = button.dataset.key;
        // Always show core modules, otherwise check if it's in the enabled list
        const isCore = ['dashboard', 'settings', 'user_management', 'module_management'].includes(key);
        const isEnabled = enabledModules.includes(key);
        if (!isCore && !isEnabled) button.style.display = 'none';
    });
  }

  // Restore last active page or default to dashboard
  const lastActivePage = localStorage.getItem('lastActivePage');
  if (lastActivePage && pages[lastActivePage]) {
    setActive(lastActivePage);
  } else {
    setActive('dashboard');
  }
}

let reportSalesChartInstance, reportFinancialChartInstance, reportHrChartInstance;
async function loadReportsDashboard() {
    const setVal = (id, text) => {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
    };

    // For now, we'll just load the default tab (Sales) with default date range.
    // The tab setup will handle loading data for other tabs.
    loadActiveReport();
    document.getElementById('printReportBtn')?.addEventListener('click', printReport);
    document.querySelectorAll('.dropdown-content a').forEach(el => {
      el.addEventListener('click', (e) => {
        e.preventDefault(); exportReport(el.dataset.format);
      });
    });
}

function getStartDateFromRange() {
    const range = document.getElementById('reportDateRange').value;
    const now = new Date();
    if (range === 'ytd') {
        return new Date(now.getFullYear(), 0, 1);
    }
    const days = parseInt(range, 10);
    const startDate = new Date();
    startDate.setDate(now.getDate() - days);
    return startDate;
}

async function loadSalesReport() {
    const setVal = (id, text) => document.getElementById(id).textContent = text;
    const startDate = getStartDateFromRange();

    const { data: orders, error } = await fetchAndCache(`sales_report_${startDate.getTime()}`, () =>
        supabase.from('sales_orders').select('total_amount, order_date').gte('order_date', startDate.toISOString())
    );

    if (error) { console.error("Error fetching sales report data:", error); return; }

    const totalRevenue = orders.reduce((sum, o) => sum + o.total_amount, 0);
    const totalOrders = orders.length;
    const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;

    setVal('report-sales-revenue', formatCurrency(totalRevenue));
    setVal('report-sales-orders', totalOrders.toLocaleString());
    setVal('report-sales-avg', formatCurrency(avgOrderValue));

    const ctx = document.getElementById('reportSalesChart');
    if (!ctx) return;
    if (reportSalesChartInstance) reportSalesChartInstance.destroy();

    const dailyRevenue = orders.reduce((acc, order) => {
        const date = new Date(order.order_date).toISOString().split('T')[0];
        acc[date] = (acc[date] || 0) + order.total_amount;
        return acc;
    }, {});

    const sortedDays = Object.keys(dailyRevenue).sort();
    const chartLabels = sortedDays.map(d => new Date(d).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }));
    const chartData = sortedDays.map(d => dailyRevenue[d]);

    reportSalesChartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels: chartLabels, datasets: [
            { label: 'Revenue', data: chartData, backgroundColor: 'rgba(59, 130, 218, 0.6)', borderColor: 'rgba(59, 130, 218, 1)', borderWidth: 1 }
        ]},
        options: { 
            responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
            scales: {
                y: { ticks: { color: document.documentElement.classList.contains('dark-mode') ? '#a0a0a0' : '#6b7280' } },
                x: { ticks: { color: document.documentElement.classList.contains('dark-mode') ? '#a0a0a0' : '#6b7280' } }
            }
        }
    });
}

async function loadFinancialReport() {
    const setVal = (id, text) => document.getElementById(id).textContent = text;

    const { data: accounts, error } = await fetchAndCache('financial_accounts_report', () =>
        supabase.from('financial_accounts').select('type, balance, name')
    );

    if (error) { console.error("Error fetching financial report data:", error); return; }

    const totalRevenue = accounts.filter(a => a.type === 'Revenue').reduce((sum, a) => sum + a.balance, 0);
    const totalExpenses = accounts.filter(a => a.type === 'Expense').reduce((sum, a) => sum + a.balance, 0);
    const netIncome = totalRevenue - totalExpenses;
    const grossMargin = totalRevenue > 0 ? (netIncome / totalRevenue) * 100 : 0;

    setVal('report-fin-net', formatCurrency(netIncome));
    setVal('report-fin-margin', `${grossMargin.toFixed(1)}%`);
    setVal('report-fin-expenses', formatCurrency(totalExpenses));

    const ctx = document.getElementById('reportFinancialChart');
    if (!ctx) return;
    if (reportFinancialChartInstance) reportFinancialChartInstance.destroy();

    const expenseAccounts = accounts.filter(a => a.type === 'Expense');
    const chartLabels = expenseAccounts.map(a => a.name);
    const chartData = expenseAccounts.map(a => a.balance);

    reportFinancialChartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels: chartLabels, datasets: [
            { label: 'Expenses', data: chartData, backgroundColor: 'rgba(239, 68, 68, 0.6)', borderColor: 'rgba(239, 68, 68, 1)', borderWidth: 1 }
        ]},
        options: { 
            responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
            scales: {
                y: { ticks: { color: document.documentElement.classList.contains('dark-mode') ? '#a0a0a0' : '#6b7280' } },
                x: { ticks: { color: document.documentElement.classList.contains('dark-mode') ? '#a0a0a0' : '#6b7280' } }
            }
        }
    });
}

async function loadInventoryReport() {
    const setVal = (id, text) => document.getElementById(id).textContent = text;
    const startDate = getStartDateFromRange();

    const [productsResult, salesResult] = await Promise.all([
        fetchAndCache('products_inventory_report', () => supabase.from('products').select('id, name, price, cost, stock_quantity')),
        fetchAndCache(`sales_orders_inventory_report_${startDate.getTime()}`, () => supabase.from('sales_orders').select('total_amount').gte('order_date', startDate.toISOString()))
    ]);

    if (productsResult.error || salesResult.error) { console.error("Error fetching inventory report data"); return; }

    const products = productsResult.data;
    const sales = salesResult.data;

    const stockValue = products.reduce((sum, p) => sum + (p.price * p.stock_quantity), 0);
    const itemsSoldCount = sales.length; // Approximation
    const costOfGoodsSold = sales.reduce((sum, s) => sum + s.total_amount, 0) * 0.5; // Approximation: 50% COGS
    const avgInventoryValue = products.reduce((sum, p) => sum + (p.cost * p.stock_quantity), 0);
    const turnoverRate = avgInventoryValue > 0 ? costOfGoodsSold / avgInventoryValue : 0;

    setVal('report-inv-value', formatCurrency(stockValue));
    setVal('report-inv-turnover', turnoverRate.toFixed(1));
    setVal('report-inv-sold', itemsSoldCount.toLocaleString());

    const tableBody = document.getElementById('reportTopProductsTable');
    if (tableBody) {
        // This is a placeholder as we don't have sales line items to get top products.
        // We'll show top stocked products instead.
        const topStocked = products.sort((a, b) => b.stock_quantity - a.stock_quantity).slice(0, 10);
        tableBody.innerHTML = topStocked.map(p => `
            <tr><td>${p.name}</td><td>${p.stock_quantity} (in stock)</td><td>${formatCurrency(p.price * p.stock_quantity)}</td></tr>
        `).join('');
    }
}

async function loadHrReport() {
    const setVal = (id, text) => document.getElementById(id).textContent = text;
    const startDate = getStartDateFromRange();

    const { data: employees, error } = await fetchAndCache('employees_report', () =>
        supabase.from('employees').select('hire_date, department')
    );

    if (error) { console.error("Error fetching HR report data:", error); return; }

    const newHires = employees.filter(e => new Date(e.hire_date) >= startDate).length;
    // Turnover is complex to calculate without termination dates, so we'll use a placeholder.
    const turnover = '2.5%'; 

    setVal('report-hr-headcount', employees.length);
    setVal('report-hr-new', newHires);
    setVal('report-hr-turnover', turnover);

    const ctx = document.getElementById('reportHrChart');
    if (!ctx) return;
    if (reportHrChartInstance) reportHrChartInstance.destroy();

    const deptCounts = employees.reduce((acc, emp) => {
        const dept = emp.department || 'Unassigned';
        acc[dept] = (acc[dept] || 0) + 1;
        return acc;
    }, {});

    reportHrChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(deptCounts),
            datasets: [{ label: 'Headcount', data: Object.values(deptCounts), backgroundColor: 'rgba(59, 130, 218, 0.6)', borderColor: 'rgba(59, 130, 218, 1)', borderWidth: 1 }]
        },
        options: { 
            responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1, color: document.documentElement.classList.contains('dark-mode') ? '#a0a0a0' : '#6b7280' } },
                x: { ticks: { color: document.documentElement.classList.contains('dark-mode') ? '#a0a0a0' : '#6b7280' } }
            }
        }
    });
}

function setupReportsTabs() {
  const tabNav = document.getElementById('reports-tab-nav');
  if (!tabNav) return;

  tabNav.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
      tabNav.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      document.querySelectorAll('#reports-tab-content .tab-content').forEach(content => {
        content.style.display = 'none';
        content.classList.remove('active');
      });
      const activeContent = document.getElementById(`tab-${button.dataset.tab}`);
      if (activeContent) { activeContent.style.display = 'block'; activeContent.classList.add('active'); }

      // Load data for the activated tab
      loadActiveReport();
    });
  });

  // Add listener for date range changes
  const dateRangeSelect = document.getElementById('reportDateRange');
  if (dateRangeSelect) {
    dateRangeSelect.addEventListener('change', loadActiveReport);
  }
}

function loadActiveReport() {
    const activeTab = document.querySelector('#reports-tab-nav .tab-button.active')?.dataset.tab;
    if (activeTab === 'sales') loadSalesReport();
    if (activeTab === 'financial') loadFinancialReport();
    if (activeTab === 'inventory') loadInventoryReport();
    if (activeTab === 'hr') loadHrReport();
}

function downloadCSV(csvContent, fileName) {
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    if (link.download !== undefined) { // feature detection
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }
}

function exportReport(format = 'csv') {
    const activeTab = document.querySelector('#reports-tab-nav .tab-button.active')?.dataset.tab;
    if (!activeTab) {
        alert('No active report tab found.');
        return;
    }

    const timestamp = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
    const fileName = `${activeTab}_report_${timestamp}`;

    if (format === 'pdf') {
        const { jsPDF } = window.jspdf;
        const reportContent = document.querySelector(`#reports-tab-content #${'tab-' + activeTab}`);
        if (!reportContent) return;

        html2canvas(reportContent, { scale: 2 }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'pt',
                format: 'a4'
            });
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save(`${fileName}.pdf`);
        });
        return;
    }

    let csvContent = '';
    
    // Header for all reports
    const dateRangeText = document.getElementById('reportDateRange').selectedOptions[0].text;
    csvContent += `Report Type: ${activeTab.charAt(0).toUpperCase() + activeTab.slice(1)}\n`;
    csvContent += `Date Range: ${dateRangeText}\n`;
    csvContent += `Export Date: ${timestamp}\n\n`;

    switch (activeTab) {
        case 'sales':
            csvContent += "Metric,Value\n";
            csvContent += `Revenue,${document.getElementById('report-sales-revenue').textContent}\n`;
            csvContent += `Orders,${document.getElementById('report-sales-orders').textContent}\n`;
            csvContent += `Average Order Value,${document.getElementById('report-sales-avg').textContent}\n\n`;
            csvContent += "Chart Data: Daily Revenue\n";
            csvContent += "Date,Revenue\n";
            reportSalesChartInstance.data.labels.forEach((label, index) => {
                csvContent += `${label},${reportSalesChartInstance.data.datasets[0].data[index]}\n`;
            });
            break;
        case 'financial':
            csvContent += "Metric,Value\n";
            csvContent += `Net Income,${document.getElementById('report-fin-net').textContent}\n`;
            csvContent += `Gross Margin,${document.getElementById('report-fin-margin').textContent}\n`;
            csvContent += `Total Expenses,${document.getElementById('report-fin-expenses').textContent}\n\n`;
            csvContent += "Chart Data: Expenses by Type\n";
            csvContent += "Account,Amount\n";
            reportFinancialChartInstance.data.labels.forEach((label, index) => {
                csvContent += `${label},${reportFinancialChartInstance.data.datasets[0].data[index]}\n`;
            });
            break;
        case 'inventory':
            csvContent += "Metric,Value\n";
            csvContent += `Stock Value,${document.getElementById('report-inv-value').textContent}\n`;
            csvContent += `Turnover Rate,${document.getElementById('report-inv-turnover').textContent}\n`;
            csvContent += `Items Sold,${document.getElementById('report-inv-sold').textContent}\n\n`;
            csvContent += "Top Selling Products\n";
            csvContent += "Product,Units Sold,Revenue\n";
            document.querySelectorAll('#reportTopProductsTable tr').forEach(row => {
                const cols = Array.from(row.querySelectorAll('td')).map(td => `"${td.textContent.replace(/"/g, '""')}"`);
                if(cols.length > 0) csvContent += cols.join(',') + '\n';
            });
            break;
        case 'hr':
            showToast('Export for HR report is not yet implemented.', 'error');
            return; // Don't download anything
    }
    
    if (format === 'excel') {
        downloadCSV(csvContent, `${fileName}.xls`);
    } else {
        downloadCSV(csvContent, `${fileName}.csv`);
    }
}

function printReport() {
    document.body.classList.add('printing'); window.print();
}

async function loadRolesData() {
  const container = document.getElementById('roleFilterContainer');
  if (!container) return;
  container.innerHTML = '<p>Loading roles...</p>';

  try {
    const { data: roles, error } = await fetchAndCache('roles_with_user_count', () => 
      supabase.from('roles').select('id, name, description, user_roles(count)').order('id')
    );
    if (error) throw error;

    if (roles && roles.length > 0) {
      // Add an "All Users" chip
      const allChip = document.createElement('div');
      allChip.className = 'role-chip active';
      allChip.textContent = 'All Users';
      allChip.onclick = () => {
        document.querySelectorAll('.role-chip').forEach(c => c.classList.remove('active'));
        allChip.classList.add('active');
        loadUsersData(); // Load all users
      };
      container.innerHTML = '';
      container.appendChild(allChip);
      roles.forEach(role => {
        const chip = document.createElement('div');
        chip.className = 'role-chip';
        const userCount = role.user_roles[0]?.count || 0;
        chip.textContent = `${role.name} (${userCount})`;
        chip.dataset.roleId = role.id;
        chip.dataset.roleName = role.name;
        chip.onclick = () => {
          document.querySelectorAll('.role-chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          loadUsersByRole(role.id, role.name);
        };
        container.appendChild(chip);
      });
    } else {
      container.innerHTML = '<p>No roles found.</p>';
    }
  } catch (error) {
      console.error("Error fetching roles:", error);
      container.innerHTML = '<p>Error loading roles.</p>';
  }
}

async function loadUsersData(roleId = null) {
  const tableBody = document.getElementById('usersTableBody');
  if (!tableBody) return;
  tableBody.innerHTML = `<tr><td colspan="5"><div class="inline-loader" style="margin: 16px auto;"></div></td></tr>`;

  try {
    let query = supabase.from('profiles').select(`id, full_name, email, department, user_roles(roles(name))`);

    // If a roleId is provided, filter by it.
    if (roleId) {
      query = supabase.from('profiles').select(`id, full_name, email, department, user_roles!inner(roles(name))`).eq('user_roles.role_id', roleId);
    }

    const cacheKey = roleId ? `users_by_role_${roleId}` : 'users_management_list';
    const { data: users, error } = await fetchAndCache(cacheKey, () => query);

    if (error) throw error;

    if (users && users.length > 0) {
      tableBody.innerHTML = users.map(user => {
        // The roles structure is different for the filtered query, so we handle both cases.
        const roles = Array.isArray(user.user_roles) 
          ? user.user_roles.map(ur => ur.roles.name).join(', ') 
          : (user.user_roles?.roles?.name || 'None');

        return `<tr>
          <td>${user.full_name || 'N/A'}</td>
          <td>${user.email || 'N/A'}</td>
          <td>${roles}</td>
          <td>${user.department || 'N/A'}</td>
          <td><button class="action-btn" onclick="showToast('Edit functionality to be added.', 'info')">Edit</button></td>
        </tr>`;
      }).join('');
    } else {
      const message = roleId ? 'No users found with this role.' : 'No users found.';
      tableBody.innerHTML = `<tr><td colspan="5">${message}</td></tr>`;
    }
  } catch (error) {
    console.error("Error fetching users for management:", error);
    tableBody.innerHTML = '<tr><td colspan="5">Error loading users.</td></tr>';
  }
}

async function loadCrmData() {
    const tableBody = document.getElementById('customersTableBody');
    if (!tableBody) return;
    tableBody.innerHTML = '<tr><td colspan="4">Loading customers...</td></tr>';

    try {
      const { data: customers, error } = await fetchAndCache('customers', () => 
          supabase.from('customers').select('name, email, phone, address').order('name', { ascending: true })
      );

      if (error) throw error;

      if (customers && customers.length > 0) {
          let tableHTML = '';
          for (const customer of customers) {
              tableHTML += `<tr>
                  <td>${customer.name || 'N/A'}</td>
                  <td>${customer.email || 'N/A'}</td>
                  <td>${customer.phone || 'N/A'}</td>
                  <td>${customer.address || 'N/A'}</td>
              </tr>`;
          }
          tableBody.innerHTML = tableHTML;
      } else {
          tableBody.innerHTML = '<tr><td colspan="4">No customers found.</td></tr>';
      }
    } catch (error) {
        console.error("Error fetching customers:", error);
        tableBody.innerHTML = '<tr><td colspan="4">Error loading data.</td></tr>';
    }
}

function setupSalesTabs() {
  const tabNav = document.getElementById('sales-tab-nav');
  if (!tabNav) return;

  tabNav.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
      // If already active, do nothing
      if (button.classList.contains('active')) return;

      tabNav.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      document.querySelectorAll('#sales-tab-content .tab-content').forEach(content => {
        content.style.display = 'none';
        content.classList.remove('active');
      });
      const activeContent = document.getElementById(`tab-${button.dataset.tab}`);
      if (activeContent) { activeContent.style.display = 'block'; activeContent.classList.add('active'); }
    });
  });
}

let topCustomersChartInstance;

function renderTopCustomersChart(topCustomers) {
    const ctx = document.getElementById('topCustomersChart');
    if (!ctx) return;

    const chartLabels = topCustomers.map(([name, _]) => name);
    const chartData = topCustomers.map(([_, revenue]) => revenue);

    const colors = getChartColors();

    if (topCustomersChartInstance) topCustomersChartInstance.destroy();
    topCustomersChartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels: chartLabels, datasets: [{ label: 'Revenue', data: chartData, backgroundColor: `${colors.accentColor}99`, borderColor: colors.accentColor, borderWidth: 1 }] },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
            scales: { y: { ticks: { color: colors.textColor }, grid: { color: 'transparent' } }, x: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } } }
        }
    });
}

async function loadLeadsData() {
    const tableBody = document.getElementById('leadsTableBody');
    if (!tableBody) return;
    tableBody.innerHTML = '<tr><td colspan="5">Loading leads...</td></tr>';

    try {
      const { data: leads, error } = await fetchAndCache('leads', () => 
          supabase.from('leads').select('name, company, email, status, source').order('created_at', { ascending: false })
      );

      if (error) throw error;

      if (leads && leads.length > 0) {
          tableBody.innerHTML = leads.map(lead => `
              <tr>
                  <td>${lead.name || 'N/A'}</td>
                  <td>${lead.company || 'N/A'}</td>
                  <td>${lead.email || 'N/A'}</td>
                  <td>${lead.status || 'N/A'}</td>
                  <td>${lead.source || 'N/A'}</td>
              </tr>
          `).join('');
      } else {
          tableBody.innerHTML = '<tr><td colspan="5">No leads found.</td></tr>';
      }
    } catch (error) {
        console.error("Error fetching leads:", error);
        tableBody.innerHTML = '<tr><td colspan="5">Error loading data.</td></tr>';
    }
}

async function loadOpportunitiesData() {
    const tableBody = document.getElementById('opportunitiesTableBody');
    if (!tableBody) return;
    tableBody.innerHTML = '<tr><td colspan="5">Loading opportunities...</td></tr>';

    try {
      const { data: opportunities, error } = await fetchAndCache('opportunities', () => 
          supabase.from('opportunities').select('name, stage, value, expected_close_date, customers (name)').order('created_at', { ascending: false })
      );

      if (error) throw error;

      if (opportunities && opportunities.length > 0) {
          tableBody.innerHTML = opportunities.map(opp => `
              <tr>
                  <td>${opp.name || 'N/A'}</td>
                  <td>${opp.customers?.name || 'N/A'}</td>
                  <td>${opp.stage || 'N/A'}</td>
                  <td>$${(opp.value || 0).toLocaleString('en-US')}</td>
                  <td>${opp.expected_close_date ? new Date(opp.expected_close_date).toLocaleDateString() : 'N/A'}</td>
              </tr>
          `).join('');
      } else {
          tableBody.innerHTML = '<tr><td colspan="5">No opportunities found.</td></tr>';
      }
    } catch (error) {
        console.error("Error fetching opportunities:", error);
        tableBody.innerHTML = '<tr><td colspan="5">Error loading data.</td></tr>';
    }
}

let opportunityStageChartInstance;
async function loadCrmDashboardData() {
    const setVal = (id, text) => {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
    };

    // --- Fetch all data in parallel ---
    const [leadsResult, opportunitiesResult, customersResult] = await Promise.all([
        fetchAndCache('leads_crm_dash', () => supabase.from('leads').select('created_at')),
        fetchAndCache('opportunities_crm_dash', () => supabase.from('opportunities').select('stage, value')),
        fetchAndCache('customers_crm_dash', () => supabase.from('customers').select('created_at'))
    ]);

    // --- Process Leads ---
    if (leadsResult.data) {
        const thirtyDaysAgo = new Date(new Date().setDate(new Date().getDate() - 30));
        const newLeadsCount = leadsResult.data.filter(l => new Date(l.created_at) > thirtyDaysAgo).length;
        setVal('crm-metric-leads', newLeadsCount);

        // Populate recent leads list
        const { data: recentLeads, error } = await fetchAndCache('leads_recent_list', () => 
          supabase.from('leads').select('name, company').order('created_at', { ascending: false }).limit(5)
        );
        const recentLeadsList = document.getElementById('crm-recent-leads-list');
        if (recentLeadsList && recentLeads) {
          recentLeadsList.innerHTML = recentLeads.map(l => `<div style="padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 13px;"><strong>${l.name}</strong><br><span style="color:var(--muted);">${l.company}</span></div>`).join('');
        }
    }

    // --- Process Opportunities ---
    if (opportunitiesResult.data) {
        const openOpportunities = opportunitiesResult.data.filter(o => o.stage !== 'Closed Won' && o.stage !== 'Closed Lost');
        const pipelineValue = openOpportunities.reduce((sum, o) => sum + o.value, 0);
        setVal('crm-metric-pipeline', `$${pipelineValue.toLocaleString('en-US')}`);

        const closedWon = opportunitiesResult.data.filter(o => o.stage === 'Closed Won').length;
        const totalClosed = opportunitiesResult.data.filter(o => o.stage === 'Closed Won' || o.stage === 'Closed Lost').length;
        const conversionRate = totalClosed > 0 ? (closedWon / totalClosed) * 100 : 0;
        setVal('crm-metric-conversion', `${conversionRate.toFixed(1)}%`);

        renderOpportunityStageChart(opportunitiesResult.data);
    }

    // --- Process Customers ---
    if (customersResult.data) {
        const thirtyDaysAgo = new Date(new Date().setDate(new Date().getDate() - 30));
        const newCustomersCount = customersResult.data.filter(c => new Date(c.created_at) > thirtyDaysAgo).length;
        setVal('crm-metric-customers', newCustomersCount);
    }
}

function renderOpportunityStageChart(opportunities) {
    const ctx = document.getElementById('opportunityStageChart');
    if (!ctx) return;

    const stageCounts = opportunities.reduce((acc, opp) => {
        acc[opp.stage] = (acc[opp.stage] || 0) + 1;
        return acc;
    }, {});

    const chartLabels = Object.keys(stageCounts);
    const chartData = Object.values(stageCounts);

    if (opportunityStageChartInstance) opportunityStageChartInstance.destroy();
    opportunityStageChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartLabels,
            datasets: [{
                label: 'Count',
                data: chartData,
                backgroundColor: 'rgba(59, 130, 218, 0.6)',
                borderColor: 'rgba(59, 130, 218, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: document.documentElement.classList.contains('dark-mode') ? '#a0a0a0' : '#6b7280', stepSize: 1 },
                    grid: { color: document.documentElement.classList.contains('dark-mode') ? 'rgba(255,255,255,0.1)' : 'rgba(15,23,42,0.1)' }
                },
                x: {
                    ticks: { color: document.documentElement.classList.contains('dark-mode') ? '#a0a0a0' : '#6b7280' },
                    grid: { color: 'transparent' }
                }
            }
        }
    });
}

function setupCrmTabs() {
  const tabNav = document.getElementById('crm-tab-nav');
  if (!tabNav) return;

  const tabButtons = tabNav.querySelectorAll('.tab-button');
  const tabContents = document.getElementById('crm-tab-content').querySelectorAll('.tab-content');

  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      tabButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      
      tabContents.forEach(content => {
        content.style.display = 'none';
      });
      const activeTab = document.getElementById(`tab-${button.dataset.tab}`);
      if(activeTab) activeTab.style.display = 'block';

      if (button.dataset.tab === 'leads') loadLeadsData();
      else if (button.dataset.tab === 'customers') loadCrmData();
      else if (button.dataset.tab === 'opportunities') loadOpportunitiesData();
    });
  });
}

async function loadHrDashboardData() {
    const setVal = (id, text) => {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
    };

    const { data: employees, error } = await fetchAndCache('employees_dashboard', () =>
        supabase.from('employees').select('first_name, last_name, hire_date, department')
    );

    if (error) {
        console.error("Error fetching HR dashboard data:", error);
        return;
    }

    if (employees) {
        // KPI Cards
        setVal('hr-metric-total', employees.length);

        const thirtyDaysAgo = new Date(new Date().setDate(new Date().getDate() - 30));
        const newHiresCount = employees.filter(e => new Date(e.hire_date) > thirtyDaysAgo).length;
        setVal('hr-metric-new', newHiresCount);

        const departments = [...new Set(employees.map(e => e.department).filter(Boolean))];
        setVal('hr-metric-depts', departments.length);

        const totalTenureDays = employees.reduce((sum, e) => {
            return sum + (new Date() - new Date(e.hire_date));
        }, 0) / (1000 * 60 * 60 * 24);
        const avgTenureYears = employees.length > 0 ? (totalTenureDays / employees.length / 365.25) : 0;
        setVal('hr-metric-tenure', `${avgTenureYears.toFixed(1)} years`);

        // Recent Hires List
        const recentHires = employees.sort((a, b) => new Date(b.hire_date) - new Date(a.hire_date)).slice(0, 5);
        const recentHiresList = document.getElementById('hr-recent-hires-list');
        if (recentHiresList) {
            recentHiresList.innerHTML = recentHires.map(e => `<div style="padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 13px;"><strong>${e.first_name} ${e.last_name}</strong><br><span style="color:var(--muted);">${e.department || 'N/A'}</span></div>`).join('');
        }

        // Department Chart
        renderDepartmentChart(employees);
    }
}

let departmentChartInstance;
function renderDepartmentChart(employees) {
    const ctx = document.getElementById('departmentChart');
    if (!ctx) return;

    const deptCounts = employees.reduce((acc, emp) => {
        const dept = emp.department || 'Unassigned';
        acc[dept] = (acc[dept] || 0) + 1;
        return acc;
    }, {});

    if (departmentChartInstance) departmentChartInstance.destroy();
    departmentChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(deptCounts),
            datasets: [{
                label: 'Employee Count',
                data: Object.values(deptCounts),
                backgroundColor: 'rgba(59, 130, 218, 0.6)',
                borderColor: 'rgba(59, 130, 218, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { color: document.documentElement.classList.contains('dark-mode') ? '#a0a0a0' : '#6b7280', stepSize: 1 } },
                x: { ticks: { color: document.documentElement.classList.contains('dark-mode') ? '#a0a0a0' : '#6b7280' } }
            }
        }
    });
}

async function loadEmployeesData() {
    const tableBody = document.getElementById('employeesTableBody');
    if (!tableBody) return;
    tableBody.innerHTML = '<tr><td colspan="5">Loading employees...</td></tr>';

    const { data: employees, error } = await fetchAndCache('employees_list', () =>
        supabase.from('employees').select('first_name, last_name, position, department, email, hire_date').order('last_name', { ascending: true })
    );

    if (error) {
        console.error("Error fetching employees:", error);
        tableBody.innerHTML = '<tr><td colspan="5">Error loading data.</td></tr>';
        return;
    }

    if (employees && employees.length > 0) {
        tableBody.innerHTML = employees.map(employee => `
            <tr>
                <td>${employee.first_name} ${employee.last_name}</td>
                <td>${employee.position || 'N/A'}</td>
                <td>${employee.department || 'N/A'}</td>
                <td>${employee.email || 'N/A'}</td>
                <td>${new Date(employee.hire_date).toLocaleDateString()}</td>
            </tr>
        `).join('');
    } else {
        tableBody.innerHTML = '<tr><td colspan="5">No employees found.</td></tr>';
    }
}

let financialPositionChartInstance;
async function loadAccountingData() {
    // This function now acts as a controller
    loadAccountingDashboardData();
    loadChartOfAccountsData(); // Load the default tab
    setupAccountingTabs();
}

async function loadAccountingDashboardData() {
    const setVal = (id, text) => {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
    };

    const { data: accounts, error } = await fetchAndCache('financial_accounts_dashboard', () =>
        supabase.from('financial_accounts').select('name, type, balance')
    );

    if (error) {
        console.error("Error fetching financial accounts for dashboard:", error);
        return;
    }

    if (accounts) {
        const totalAssets = accounts.filter(a => a.type === 'Asset').reduce((sum, a) => sum + a.balance, 0);
        const totalLiabilities = accounts.filter(a => a.type === 'Liability').reduce((sum, a) => sum + a.balance, 0);
        const totalEquity = accounts.filter(a => a.type === 'Equity').reduce((sum, a) => sum + a.balance, 0);
        const totalRevenue = accounts.filter(a => a.type === 'Revenue').reduce((sum, a) => sum + a.balance, 0);
        const totalExpenses = accounts.filter(a => a.type === 'Expense').reduce((sum, a) => sum + a.balance, 0);
        const accountsReceivable = accounts.find(a => a.name === 'Accounts Receivable')?.balance || 0;

        setVal('acct-metric-assets', formatCurrency(totalAssets));
        setVal('acct-metric-liabilities', formatCurrency(totalLiabilities + totalEquity));
        setVal('acct-metric-net-income', formatCurrency(totalRevenue - totalExpenses));
        setVal('acct-metric-ar', formatCurrency(accountsReceivable));

        renderFinancialPositionChart({ totalAssets, totalLiabilities, totalEquity });
    }
}

function renderFinancialPositionChart({ totalAssets, totalLiabilities, totalEquity }) {
    const ctx = document.getElementById('financialPositionChart');
    if (!ctx) return;

    if (financialPositionChartInstance) financialPositionChartInstance.destroy();

    financialPositionChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Assets', 'Liabilities', 'Equity'],
            datasets: [{
                data: [totalAssets, totalLiabilities, totalEquity],
                backgroundColor: ['#3b8eda', '#f59e0b', '#10b981'],
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { color: document.documentElement.classList.contains('dark-mode') ? '#a0a0a0' : '#6b7280' } }
            }
        }
    });
}

async function loadChartOfAccountsData() {
    const tableBody = document.getElementById('chartOfAccountsBody');
    if (!tableBody) return;
    tableBody.innerHTML = '<tr><td colspan="4">Loading accounts...</td></tr>';

    const { data: accounts, error } = await fetchAndCache('financial_accounts', () => 
        supabase.from('financial_accounts').select('account_number, name, type, balance').order('account_number', { ascending: true })
    );

    if (error) {
        console.error("Error fetching chart of accounts:", error);
        tableBody.innerHTML = '<tr><td colspan="4">Error loading data.</td></tr>';
        return;
    }

    if (accounts && accounts.length > 0) {
        tableBody.innerHTML = accounts.map(account => `
            <tr>
                <td>${account.account_number}</td>
                <td>${account.name}</td>
                <td>${account.type}</td>
                <td>${(account.balance || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
            </tr>
        `).join('');
    } else {
        tableBody.innerHTML = '<tr><td colspan="4">No accounts found.</td></tr>';
    }
}

async function loadJournalEntriesData() {
    const tableBody = document.getElementById('journalEntriesBody');
    if (!tableBody) return;
    tableBody.innerHTML = '<tr><td colspan="4">Loading journal entries...</td></tr>';
    // This is a placeholder as we don't have a journal_entries table yet.
    // In a real scenario, you would fetch from a 'journal_entries' table.
    setTimeout(() => {
        tableBody.innerHTML = '<tr><td colspan="4">No journal entries found. (Feature to be implemented)</td></tr>';
    }, 500);
}

function setupAccountingTabs() {
  const tabNav = document.getElementById('accounting-tab-nav');
  if (!tabNav) return;

  tabNav.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
      tabNav.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      document.querySelectorAll('#accounting-tab-content .tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`tab-${button.dataset.tab}`).classList.add('active');

      if (button.dataset.tab === 'accounts') loadChartOfAccountsData();
      if (button.dataset.tab === 'journals') loadJournalEntriesData();
    });
  });
}

let productionStatusChartInstance;
async function loadManufacturingPage() {
    // Controller function
    loadManufacturingDashboardData();
    loadProductionOrdersData(); // Default tab
    setupManufacturingTabs();
}

function renderProductionStatusChart(orders) {
    const ctx = document.getElementById('productionStatusChart');
    if (!ctx) return;

    const statusCounts = orders.reduce((acc, order) => {
        acc[order.status] = (acc[order.status] || 0) + 1;
        return acc;
    }, {});

    if (productionStatusChartInstance) productionStatusChartInstance.destroy();

    productionStatusChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(statusCounts),
            datasets: [{
                data: Object.values(statusCounts),
                backgroundColor: ['#3b8eda', '#f59e0b', '#10b981', '#ef4444', '#6b7280'],
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { color: document.documentElement.classList.contains('dark-mode') ? '#a0a0a0' : '#6b7280' } }
            }
        }
    });
}

async function loadProductionOrdersData() {
    const tableBody = document.getElementById('productionOrdersTableBody');
    if (!tableBody) return;
    tableBody.innerHTML = '<tr><td colspan="5">Loading production orders...</td></tr>';

    const { data: orders, error } = await fetchAndCache('production_orders_list', () =>
        supabase.from('production_orders').select('id, quantity_to_produce, status, completion_date, products (name)').order('id', { ascending: false })
    );

    if (error) {
        console.error("Error fetching production orders:", error);
        tableBody.innerHTML = '<tr><td colspan="5">Error loading data.</td></tr>';
        return;
    }

    if (orders && orders.length > 0) {
        tableBody.innerHTML = orders.map(order => `
            <tr>
                <td>PO-${order.id}</td>
                <td>${order.products?.name || 'N/A'}</td>
                <td>${order.quantity_to_produce}</td>
                <td>${order.status}</td>
                <td>${order.completion_date ? new Date(order.completion_date).toLocaleDateString() : 'N/A'}</td>
            </tr>
        `).join('');
    } else {
        tableBody.innerHTML = '<tr><td colspan="5">No production orders found.</td></tr>';
    }
}

async function loadBomData() {
    const tableBody = document.getElementById('bomTableBody');
    if (!tableBody) return;
    tableBody.innerHTML = '<tr><td colspan="3">Loading Bill of Materials...</td></tr>';
    // This is a placeholder as we don't have a bom table yet.
    setTimeout(() => {
        tableBody.innerHTML = '<tr><td colspan="3">No BOM data found. (Feature to be implemented)</td></tr>';
    }, 500);
}

function setupManufacturingTabs() {
  const tabNav = document.getElementById('mfg-tab-nav');
  if (!tabNav) return;

  tabNav.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
      tabNav.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      document.querySelectorAll('#mfg-tab-content .tab-content').forEach(content => content.style.display = 'none');
      document.getElementById(`tab-${button.dataset.tab}`).style.display = 'block';

      if (button.dataset.tab === 'orders') loadProductionOrdersData();
      if (button.dataset.tab === 'bom') loadBomData();
    });
  });
}

function setupPurchasingTabs() {
  const tabNav = document.getElementById('po-tab-nav');
  if (!tabNav) return;

  tabNav.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
      tabNav.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      document.querySelectorAll('#po-tab-content .tab-content').forEach(content => {
        content.classList.remove('active');
        content.style.display = 'none';
      });
      const activeTab = document.getElementById(`tab-${button.dataset.tab}`);
      activeTab.classList.add('active');
      activeTab.style.display = 'block';

      if (button.dataset.tab === 'po') {
        loadPurchaseOrdersData();
      } else if (button.dataset.tab === 'suppliers') {
        loadSuppliersData();
      }
    });
  });
}

function attachToggleListeners(){
  document.querySelectorAll('.toggle').forEach(t=>{
    t.addEventListener('click',()=>{
      if(t.dataset.setting==='darkMode') toggleDarkMode();
      else if(t.dataset.setting==='nightLight') toggleNightLight();
      else if(t.dataset.setting==='taxExempt') toggleTaxExempt();
      else {t.classList.toggle('on');t.setAttribute('aria-checked',t.classList.contains('on'));}
    });
  });
  document.querySelectorAll('input[data-setting="brightness"]').forEach(slider => {
    slider.addEventListener('input', e => {
      const newBrightness = e.target.value;
      setBrightness(newBrightness, true);
    });
  });
}

function setupInventoryFilters() {
    const searchInput = document.getElementById('inventorySearch');
    const categoryFilter = document.getElementById('inventoryCategoryFilter');
    const stockFilter = document.getElementById('inventoryStockFilter');

    const applyFilters = () => {
        const searchQuery = searchInput.value.toLowerCase();
        const category = categoryFilter.value;
        const stockStatus = stockFilter.value;
        renderInventoryTable(currentProducts, { searchQuery, category, stockStatus });
    };

    searchInput?.addEventListener('input', applyFilters);
    categoryFilter?.addEventListener('change', applyFilters);
    stockFilter?.addEventListener('change', applyFilters);
}


let currentProducts = []; // To hold the list of products for the inventory page


async function loadInventoryData() {
    const inventoryTableBody = document.getElementById('inventoryTableBody');
    if (!inventoryTableBody) return;
    inventoryTableBody.innerHTML = '<tr><td colspan="8">Loading products...</td></tr>';

    try {
        const { data: products, error } = await fetchAndCache('products_list', () =>
            supabase.from('products').select('id, sku, name, category, price, cost, stock_quantity').eq('is_active', true).order('name', { ascending: true })
        );

        if (error) throw error;

        currentProducts = products || [];
        renderInventoryTable(currentProducts); // Initial render
        setupInventoryFilters(); // Setup filter listeners

    } catch (error) {
        console.error("Error fetching products:", error);
        inventoryTableBody.innerHTML = '<tr><td colspan="8">Error loading data.</td></tr>';
    }
}

function renderInventoryTable(products, filters = {}) {
    const inventoryTableBody = document.getElementById('inventoryTableBody');
    if (!inventoryTableBody) return;

    const { searchQuery = '', category = 'all', stockStatus = 'all' } = filters;

    const filteredProducts = products.filter(p => {
        const matchesSearch = !searchQuery || p.name.toLowerCase().includes(searchQuery) || (p.sku && p.sku.toLowerCase().includes(searchQuery));
        const matchesCategory = category === 'all' || p.category === category;
        const matchesStock = stockStatus === 'all' ||
            (stockStatus === 'in_stock' && p.stock_quantity > 0) ||
            (stockStatus === 'low_stock' && p.stock_quantity > 0 && p.stock_quantity < 10) ||
            (stockStatus === 'out_of_stock' && p.stock_quantity === 0);
        return matchesSearch && matchesCategory && matchesStock;
    });

    if (filteredProducts.length > 0) {
        inventoryTableBody.innerHTML = filteredProducts.map(product => {
            const stockClass = product.stock_quantity === 0 ? 'low-stock' : (product.stock_quantity < 10 ? 'low-stock' : '');
            const stockValue = (product.cost || 0) * product.stock_quantity;
            return `<tr>
                <td>${product.sku || ''}</td>
                <td>${product.name || ''}</td>
                <td>${product.category || ''}</td>
                <td>${formatCurrency(product.price)}</td>
                <td>${formatCurrency(product.cost)}</td>
                <td class="${stockClass}">${product.stock_quantity}</td>
                <td>${formatCurrency(stockValue)}</td>
                <td class="actions-group" style="gap: 4px;">
                  <button class="action-btn" data-action="restock-product" data-id="${product.id}" title="Restock">Restock</button>
                  <button class="action-btn" data-action="edit-product" data-id="${product.id}" style="background: var(--muted);" title="Edit">Edit</button>
                  <button class="action-btn danger" data-action="delete-product" data-id="${product.id}">Archive</button>
                </td>
            </tr>`;
        }).join('');
    } else {
        inventoryTableBody.innerHTML = `<tr><td colspan="8">No products match the current filters.</td></tr>`;
    }
}

let stockCategoryChartInstance;
async function loadInventoryDashboard() {
    loadInventoryData(); // Load the main table

    const setVal = (id, text) => {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
    };

    const { data: products, error } = await fetchAndCache('products_dashboard', () =>
        supabase.from('products').select('price, cost, stock_quantity, category').eq('is_active', true)
    );

    if (error) {
        console.error("Error fetching inventory dashboard data:", error);
        return;
    }

    if (products) {
        const totalValue = products.reduce((sum, p) => sum + ((p.cost || 0) * p.stock_quantity), 0);
        const lowStock = products.filter(p => p.stock_quantity > 0 && p.stock_quantity < 10).length;
        const outOfStock = products.filter(p => p.stock_quantity === 0).length;
        const totalSkus = products.length;

        setVal('inv-metric-value', formatCurrency(totalValue));
        setVal('inv-metric-low', `${lowStock} items`);
        setVal('inv-metric-out', `${outOfStock} items`);
        setVal('inv-metric-skus', totalSkus);

        // Populate category filter dropdown
        const categoryFilter = document.getElementById('inventoryCategoryFilter');
        if (categoryFilter) {
            const categories = [...new Set(products.map(p => p.category).filter(Boolean))].sort();
            // Preserve the "All Categories" option
            categoryFilter.innerHTML = '<option value="all">All Categories</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }
    }
}

function renderStockCategoryChart(products) {
    // This chart is no longer in the template, so we can skip rendering it.
    // If you want to add it back, you can place a <canvas id="stockCategoryChart"></canvas>
    // somewhere in the template and this function will work.
    const ctx = document.getElementById('stockCategoryChart');
    if (!ctx) return;

    const categoryCounts = products.reduce((acc, product) => {
        const category = product.category || 'Uncategorized';
        acc[category] = (acc[category] || 0) + 1;
        return acc;
    }, {});

    if (stockCategoryChartInstance) stockCategoryChartInstance.destroy();

    stockCategoryChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(categoryCounts),
            datasets: [{
                data: Object.values(categoryCounts),
                backgroundColor: ['#3b8eda', '#f59e0b', '#10b981', '#ef4444', '#6b7280', '#8b5cf6'],
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { color: document.documentElement.classList.contains('dark-mode') ? '#a0a0a0' : '#6b7280' } }
            }
        }
    });
}

async function openProductModal(productId = null) {
    const modal = document.getElementById('appModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalSaveBtn = document.getElementById('modalSaveBtn');

    // Fetch categories for the dropdown
    const { data: categories, error } = await fetchAndCache('product_categories', () =>
        supabase.from('product_categories').select('name').order('name')
    );
    if (error) {
        alert('Error fetching product categories.');
        console.error(error);
        return;
    }

    let product = null;
    if (productId !== null) {
        product = currentProducts.find(p => p.id === productId);
        if (!product) { alert('Product not found!'); return; }
    }

    const isEdit = product !== null;
    const categoryOptions = categories.map(cat => 
        `<option value="${cat.name}" ${isEdit && product.category === cat.name ? 'selected' : ''}>${cat.name}</option>`
    ).join('');

    modalTitle.textContent = isEdit ? `Edit Product: ${product.name}` : 'Add New Product';

    modalBody.innerHTML = `
        <div class="full-width"><label for="productName">Product Name</label><input id="productName" value="${isEdit ? product.name : ''}"></div>
        <div><label for="productSku">SKU</label><input id="productSku" value="${isEdit ? product.sku : ''}"></div>
        <div><label for="productCategory">Category</label><select id="productCategory">${categoryOptions}</select></div>
        <div><label for="productPrice">Price</label><input id="productPrice" type="number" step="0.01" value="${isEdit ? product.price : ''}"></div>
        <div><label for="productCost">Cost</label><input id="productCost" type="number" step="0.01" value="${isEdit ? product.cost : ''}"></div>
        <div class="full-width"><label for="productStock">Stock Quantity</label><input id="productStock" type="number" step="1" value="${isEdit ? product.stock_quantity : '0'}"></div>
    `;

    // Clone and replace the button to remove old event listeners
    const newSaveBtn = modalSaveBtn.cloneNode(true);
    modalSaveBtn.parentNode.replaceChild(newSaveBtn, modalSaveBtn);

    newSaveBtn.onclick = () => {
        const productData = {
            name: document.getElementById('productName').value,
            sku: document.getElementById('productSku').value,
            category: document.getElementById('productCategory').value,
            price: parseFloat(document.getElementById('productPrice').value) || 0,
            cost: parseFloat(document.getElementById('productCost').value) || 0,
            stock_quantity: parseInt(document.getElementById('productStock').value) || 0,
        };

        if (isEdit) {
            updateProduct(product.id, productData);
        } else {
            addProduct(productData);
        }
    };

    modal.style.display = 'flex';
}

async function openRestockModal(productId) {
    const product = currentProducts.find(p => p.id === productId);
    if (!product) {
        showToast('Product not found!', 'error');
        return;
    }

    const modal = document.getElementById('appModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalSaveBtn = document.getElementById('modalSaveBtn');

    modalTitle.textContent = `Restock: ${product.name}`;
    modalBody.innerHTML = `
        <div class="full-width" style="text-align: center; padding-bottom: 12px;">
            <p style="font-size: 14px; color: var(--muted);">Current Stock</p>
            <p style="font-size: 32px; font-weight: 600; margin-top: 4px;">${product.stock_quantity}</p>
        </div>
        <div class="full-width">
            <label for="restockQuantity">Quantity to Add</label>
            <input id="restockQuantity" type="number" step="1" min="1" placeholder="e.g., 50" autofocus>
        </div>
    `;

    // Clone and replace the button to remove old event listeners
    const newSaveBtn = modalSaveBtn.cloneNode(true);
    newSaveBtn.textContent = 'Add to Stock';
    modalSaveBtn.parentNode.replaceChild(newSaveBtn, modalSaveBtn);

    newSaveBtn.onclick = () => {
        const quantityToAdd = parseInt(document.getElementById('restockQuantity').value, 10);
        if (isNaN(quantityToAdd) || quantityToAdd <= 0) {
            showToast('Please enter a valid quantity to add.', 'error');
            return;
        }
        restockProduct(productId, quantityToAdd);
    };

    modal.style.display = 'flex';
    // Focus the input field
    setTimeout(() => {
        document.getElementById('restockQuantity').focus();
    }, 100);
}

function closeModal() {
    document.getElementById('appModal').style.display = 'none';
}

async function addProduct(productData) {
    if (!productData.name) {        showToast('Product Name is required.', 'error');
        return;
    }
    const { error } = await supabase.from('products').insert(productData);
    if (error) {
        // Check for a unique constraint violation (409 Conflict)
        if (error.code === '23505' || error.message.includes('duplicate key value violates unique constraint')) {
            showToast('Error: A product with this SKU already exists. Please use a unique SKU.', 'error');
        } else {
            showToast(`Error adding product: ${error.message}`, 'error');
        }
    } else {
        alert('Product added successfully!');
        closeModal();
        // Invalidate cache and reload
        appCache['products_list'] = null;
        appCache['products_dashboard'] = null;
        loadInventoryDashboard();
    }
}

async function updateProduct(id, productData) {
    if (!productData.name) {        showToast('Product Name is required.', 'error');
        return;
    }
    const { error } = await supabase.from('products').update(productData).eq('id', id);
    if (error) {
        showToast(`Error updating product: ${error.message}`, 'error');
    } else {
        showToast('Product updated successfully!');
        closeModal();
        // Invalidate cache and reload
        appCache['products_list'] = null;
        appCache['products_dashboard'] = null;
        loadInventoryDashboard();
    }
}

async function restockProduct(productId, quantityToAdd) {
    try {
        // Use an RPC function to ensure the update is atomic (prevents race conditions)
        const { error } = await supabase.rpc('increment_stock', {
            p_id: productId,
            p_quantity: quantityToAdd
        });

        if (error) throw error;

        showToast(`Successfully added ${quantityToAdd} units to stock.`);
        closeModal();
        // Invalidate cache and reload
        appCache['products_list'] = null;
        loadInventoryData();
    } catch (error) {
        console.error('Error restocking product:', error);
        showToast(`Failed to restock product: ${error.message}`, 'error');
    }
}

async function deleteProduct(id) {
    const product = currentProducts.find(p => p.id === id);
    if (!product) { alert('Product not found!'); return; }
    const name = product.name;

    if (confirm(`Are you sure you want to archive "${name}"? The product will be hidden from active lists but its historical data will be preserved.`)) {
        try {
            const { error } = await supabase.from('products').update({ is_active: false }).eq('id', id);
            if (error) throw error;

            showToast('Product archived successfully.');
            // Invalidate cache and reload
            appCache['products_list'] = null;
            appCache['products_dashboard'] = null;
            loadInventoryDashboard();
        } catch (error) {
            console.error('Error archiving product:', error);
            showToast(`Failed to archive product: ${error.message}`, 'error');
        }
    }
}

async function loadPurchasingDashboard() {
    loadPurchaseOrdersData(); // Load default tab
    setupPurchasingTabs();

    // Placeholder for dashboard metrics
    const setVal = (id, text) => {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
    };
    setVal('po-metric-open', 'N/A');
    setVal('po-metric-overdue', 'N/A');
    setVal('po-metric-spend', 'N/A');
    setVal('po-metric-suppliers', 'N/A');
}

async function loadPurchasingData() {
    const suppliersTableBody = document.getElementById('suppliersTableBody');
    if (!suppliersTableBody) return;
    suppliersTableBody.innerHTML = '<tr><td colspan="4">Loading suppliers...</td></tr>';
    try {
      const { data: suppliers, error } = await fetchAndCache('suppliers', () => 
          supabase.from('suppliers').select('name, contact_person, email, phone').order('name', { ascending: true })
      );

      if (error) throw error;

      if (suppliers && suppliers.length > 0) {
          let tableHTML = '';
          for (const supplier of suppliers) {
              tableHTML += `<tr>
                  <td>${supplier.name || 'N/A'}</td>
                  <td>${supplier.contact_person || 'N/A'}</td>
                  <td>${supplier.email || 'N/A'}</td>
                  <td>${supplier.phone || 'N/A'}</td>
              </tr>`;
          }
          suppliersTableBody.innerHTML = tableHTML;
      } else {
          suppliersTableBody.innerHTML = '<tr><td colspan="4">No suppliers found.</td></tr>';
      }
    } catch (error) {
        console.error("Error fetching suppliers:", error);
        suppliersTableBody.innerHTML = '<tr><td colspan="4">Error loading data.</td></tr>';
    }
}

async function loadSuppliersData() {
    const tableBody = document.getElementById('suppliersTableBody');
    if (!tableBody) return;
    tableBody.innerHTML = '<tr><td colspan="4">Loading suppliers...</td></tr>';

    const { data: suppliers, error } = await fetchAndCache('suppliers_list', () =>
        supabase.from('suppliers').select('name, contact_person, email, phone').order('name')
    );

    if (error) {
        tableBody.innerHTML = '<tr><td colspan="4">Error loading suppliers.</td></tr>';
        return;
    }

    if (suppliers && suppliers.length > 0) {
        tableBody.innerHTML = suppliers.map(s => `
            <tr>
                <td>${s.name || 'N/A'}</td>
                <td>${s.contact_person || 'N/A'}</td>
                <td>${s.email || 'N/A'}</td>
                <td>${s.phone || 'N/A'}</td>
            </tr>
        `).join('');
    } else {
        tableBody.innerHTML = '<tr><td colspan="4">No suppliers found.</td></tr>';
    }
}

async function loadPurchaseOrdersData() {
    const tableBody = document.getElementById('purchaseOrdersTableBody');
    if (!tableBody) return;
    tableBody.innerHTML = '<tr><td colspan="5">Loading purchase orders...</td></tr>';
    // This is a placeholder as we don't have a purchase_orders table yet.
    setTimeout(() => {
        tableBody.innerHTML = '<tr><td colspan="5">No purchase orders found. (Feature to be implemented)</td></tr>';
    }, 500);
}

async function loadSalesData() {
    const salesTableBody = document.getElementById('salesTableBody');
    if (!salesTableBody) return;
    salesTableBody.innerHTML = '<tr><td colspan="5">Loading sales data...</td></tr>';

    try {
      const { data: salesOrders, error: salesError } = await fetchAndCache('sales_orders', () => 
          supabase.from('sales_orders').select('id, customer_id, order_date, status, total_amount, customers (name)')
      );

      if (salesError) throw salesError;

      if (salesOrders && salesOrders.length > 0) {
          let tableHTML = '';
          for (const order of salesOrders) {
              tableHTML += `<tr>
                  <td>${order.id}</td>
                  <td>${order.customers?.name || 'N/A'}</td>
                  <td>${new Date(order.order_date).toLocaleDateString()}</td>
                  <td>${order.status}</td>
                  <td>$${order.total_amount.toFixed(2)}</td>
              </tr>`;
          }
          salesTableBody.innerHTML = tableHTML;
      } else {
          salesTableBody.innerHTML = '<tr><td colspan="5">No sales orders found.</td></tr>';
      }
    } catch (error) {
        console.error("Error fetching sales orders:", error);
        salesTableBody.innerHTML = '<tr><td colspan="5">Error loading sales data.</td></tr>';
    }
}

let dailySalesChartInstance;
async function loadSalesDashboard() {
    setupSalesTabs();
    const setVal = (id, main, sub = '') => {
        const el = document.getElementById(id);
        if (el) el.textContent = main;
        const subEl = document.getElementById(id + '-sub');
        if (subEl) subEl.innerHTML = sub;
    };

    const sixtyDaysAgo = new Date(new Date().setDate(new Date().getDate() - 60)).toISOString();
    const { data: orders, error } = await fetchAndCache('sales_orders_dashboard_full', () => 
        supabase.from('sales_orders').select('id, total_amount, order_date, status, customers (id, name, email), order_items(quantity, products(cost))').gte('order_date', sixtyDaysAgo)
    );

    loadSalesData(orders); // Load the main table with all fetched orders

    if (error) {
        console.error("Error fetching sales dashboard data:", error);
        return;
    }

    if (orders) { 
        const thirtyDaysAgoISO = new Date(new Date().setDate(new Date().getDate() - 30)).toISOString();
        // Filter for completed/shipped orders for revenue calculation
        const revenueOrders = orders.filter(o => o.status === 'completed' || o.status === 'shipped');

        const recentOrders = revenueOrders.filter(o => o.order_date >= thirtyDaysAgoISO);
        const previousOrders = revenueOrders.filter(o => o.order_date < thirtyDaysAgoISO);

        const recentRevenue = recentOrders.reduce((sum, o) => sum + o.total_amount, 0);
        const previousRevenue = previousOrders.reduce((sum, o) => sum + o.total_amount, 0);

        const newOrdersCount = recentOrders.length;
        const previousOrdersCount = previousOrders.length;

        const avgOrderValue = newOrdersCount > 0 ? recentRevenue / newOrdersCount : 0;
        const prevAvgOrderValue = previousOrdersCount > 0 ? previousRevenue / previousOrdersCount : 0;

        const pendingShipments = orders.filter(o => o.status === 'pending' || o.status === 'processing').length;

        // Accurate profit calculation
        const calculateCogs = (orderList) => orderList.reduce((cogsSum, order) => {
            const orderCogs = order.order_items.reduce((itemSum, item) => itemSum + (item.quantity * (item.products?.cost || 0)), 0);
            return cogsSum + orderCogs;
        }, 0);

        const recentCogs = calculateCogs(recentOrders);
        const previousCogs = calculateCogs(previousOrders);
        const grossProfit = recentRevenue - recentCogs;
        const prevGrossProfit = previousRevenue - previousCogs;

        setVal('sales-metric-revenue', formatCurrency(recentRevenue), renderIndicator(previousRevenue, recentRevenue));
        setVal('sales-metric-profit', formatCurrency(grossProfit), renderIndicator(prevGrossProfit, grossProfit));
        setVal('sales-metric-orders', newOrdersCount, renderIndicator(previousOrdersCount, newOrdersCount));
        setVal('sales-metric-avg', formatCurrency(avgOrderValue), renderIndicator(prevAvgOrderValue, avgOrderValue));
        setVal('sales-metric-pending', pendingShipments);

        // Calculate Items Sold
        const now = new Date();
        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
        const weekStart = new Date(now.setDate(now.getDate() - now.getDay())).toISOString().split('T')[0];
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();

        const itemsSoldToday = orders
            .filter(o => o.order_date >= todayStart)
            .reduce((sum, o) => sum + o.order_items.reduce((itemSum, item) => itemSum + item.quantity, 0), 0);

        const itemsSoldThisWeek = orders
            .filter(o => o.order_date >= weekStart)
            .reduce((sum, o) => sum + o.order_items.reduce((itemSum, item) => itemSum + item.quantity, 0), 0);

        const itemsSoldThisMonth = orders
            .filter(o => o.order_date >= monthStart)
            .reduce((sum, o) => sum + o.order_items.reduce((itemSum, item) => itemSum + item.quantity, 0), 0);

        const itemsSoldElToday = document.getElementById('sales-metric-items-today');
        const itemsSoldElWeek = document.getElementById('sales-metric-items-week');
        const itemsSoldElMonth = document.getElementById('sales-metric-items-month');
        if (itemsSoldElToday) itemsSoldElToday.textContent = itemsSoldToday.toLocaleString();
        if (itemsSoldElWeek) itemsSoldElWeek.textContent = itemsSoldThisWeek.toLocaleString();
        if (itemsSoldElMonth) itemsSoldElMonth.textContent = itemsSoldThisMonth.toLocaleString();

        renderDailySalesChart(recentOrders);

        // Top Customers
        const customerRevenue = orders.reduce((acc, order) => {
            const customerName = order.customers?.name || 'Unknown';
            acc[customerName] = (acc[customerName] || 0) + order.total_amount;
            return acc;
        }, {});
        const topCustomers = Object.entries(customerRevenue).sort((a, b) => b[1] - a[1]).slice(0, 5);
        const topCustomersList = document.getElementById('sales-top-customers');
        if (topCustomersList) {
            topCustomersList.innerHTML = topCustomers.map(([name, revenue]) => `<div style="padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 13px;"><strong>${name}</strong><br><span style="color:var(--muted);">${formatCurrency(revenue)}</span></div>`).join('');
        }

        const statusFilter = document.getElementById('salesStatusFilter');
        if (statusFilter) {
            statusFilter.addEventListener('change', () => loadSalesData(orders));
        }
    }
}

function renderDailySalesChart(orders) {
    const ctx = document.getElementById('dailySalesChart');
    if (!ctx) return;

    const dailySales = orders.reduce((acc, order) => {
        const date = new Date(order.order_date).toISOString().split('T')[0];
        acc[date] = (acc[date] || 0) + order.total_amount;
        return acc;
    }, {});

    const sortedDays = Object.keys(dailySales).sort();
    const chartLabels = sortedDays.map(date => new Date(date).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }));
    const chartData = sortedDays.map(date => dailySales[date]);

    if (dailySalesChartInstance) dailySalesChartInstance.destroy();
    dailySalesChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartLabels,
            datasets: [{
                label: 'Sales',
                data: chartData,
                borderColor: 'rgba(59, 130, 218, 1)',
                backgroundColor: 'rgba(59, 130, 218, 0.1)',
                fill: true,
                tension: 0.3,
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
            scales: { y: { ticks: { color: document.documentElement.classList.contains('dark-mode') ? '#a0a0a0' : '#6b7280' } }, x: { ticks: { color: document.documentElement.classList.contains('dark-mode') ? '#a0a0a0' : '#6b7280' } } }
        }
    });
}

function renderIndicator(prev, current) {
    if (prev === 0 && current > 0) {
        return `<span class="indicator up"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 17a.75.75 0 0 1-.75-.75V5.612L5.03 9.83a.75.75 0 0 1-1.06-1.06l5.25-5.25a.75.75 0 0 1 1.06 0l5.25 5.25a.75.75 0 1 1-1.06 1.06L10.75 5.612V16.25a.75.75 0 0 1-.75.75Z" clip-rule="evenodd" /></svg> New Activity</span>`;
    }
    if (prev === 0 || prev === current) {
        return `<span>- vs prev. period</span>`;
    }
    const percentChange = ((current - prev) / prev) * 100;
    const direction = percentChange > 0 ? 'up' : 'down';
    const symbol = direction === 'up' 
        ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 17a.75.75 0 0 1-.75-.75V5.612L5.03 9.83a.75.75 0 0 1-1.06-1.06l5.25-5.25a.75.75 0 0 1 1.06 0l5.25 5.25a.75.75 0 1 1-1.06 1.06L10.75 5.612V16.25a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" /></svg>` 
        : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a.75.75 0 0 1 .75.75v10.638l4.22-4.22a.75.75 0 1 1 1.06 1.06l-5.25 5.25a.75.75 0 0 1-1.06 0l-5.25-5.25a.75.75 0 1 1 1.06-1.06L9.25 14.388V3.75A.75.75 0 0 1 10 3Z" clip-rule="evenodd" /></svg>`;
    return `<span class="indicator ${direction}">${symbol} ${Math.abs(percentChange).toFixed(1)}%</span>`;
}

async function loadDashboardData() {
  // Set default loading text
  const loadingSpinner = '<div class="inline-loader"></div>';
  const setVal = (id, main, sub = '') => {
    const el = document.getElementById(id);
    if (el) el.innerHTML = main; // Use innerHTML to render the spinner
    const subEl = document.getElementById(id + '-sub');
    if (subEl) subEl.innerHTML = sub; // Use innerHTML to render the indicator's SVG icons
  };
  setVal('db-total-sales', loadingSpinner);
  setVal('db-open-orders', loadingSpinner);
  setVal('db-inventory-alerts', loadingSpinner);
  setVal('db-employees', loadingSpinner);
  // The new-leads metric is not on the dashboard in the provided file, but this would be the pattern.
  // setVal('db-new-leads', loadingSpinner);
  
  try {
    // 1. Fetch Sales (30d)
    const thirtyDaysAgo = new Date(new Date().setDate(new Date().getDate() - 30)).toISOString();
    const sixtyDaysAgo = new Date(new Date().setDate(new Date().getDate() - 60)).toISOString();

    const { data: salesData, error: salesError } = await fetchAndCache('sales_orders_dashboard', () => 
      supabase.from('sales_orders').select('total_amount, order_date').in('status', ['completed', 'shipped']).gte('order_date', sixtyDaysAgo)
    );
    if (salesError) throw salesError;
    if (salesData) {
      const currentPeriodSales = salesData
        .filter(o => o.order_date >= thirtyDaysAgo)
        .reduce((sum, order) => sum + order.total_amount, 0);
      
      const previousPeriodSales = salesData
        .filter(o => o.order_date < thirtyDaysAgo)
        .reduce((sum, order) => sum + order.total_amount, 0);

      setVal('db-total-sales', formatCurrency(currentPeriodSales), renderIndicator(previousPeriodSales, currentPeriodSales));
      renderSalesChart(salesData);
    }

    // 2. Fetch Open Orders (count of pending orders)
    const { count: openOrdersCount, error: openOrdersError } = await fetchAndCache('open_orders_count', () => 
      supabase.from('sales_orders').select('*', { count: 'exact', head: true }).eq('status', 'pending')
    );
    if (openOrdersError) throw openOrdersError;
    if (openOrdersCount !== null) setVal('db-open-orders', `${openOrdersCount}`, `Orders Pending`);

    // 3. Fetch Inventory Alerts (stock < 10)
    const { data: products, error: inventoryError } = await fetchAndCache('products_dashboard', () => 
      supabase.from('products').select('name, stock_quantity').eq('is_active', true).order('stock_quantity', { ascending: false })
    );
    if (inventoryError) throw inventoryError;
    if (products) {
      const lowStockCount = products.filter(p => p.stock_quantity < 10).length;
      setVal('db-inventory-alerts', `${lowStockCount}`, `Products low in stock`);
      renderInventoryChart(products.slice(0, 5)); // Top 5 products
    }

    // 4. Fetch Employee Count
    const { count: employeeCount, error: employeeError } = await fetchAndCache('employee_count', () => 
      supabase.from('employees').select('*', { count: 'exact', head: true })
    );
    if (employeeError) throw employeeError;
    if (employeeCount !== null) setVal('db-employees', `${employeeCount}`, `Active Employees`);

  } catch (error) {
    console.error("Dashboard loading error:", error);
  }
}

let salesChartInstance, inventoryChartInstance;

function getChartColors() {
    const style = getComputedStyle(document.documentElement);
    return {
        textColor: style.getPropertyValue('--muted').trim(),
        gridColor: style.getPropertyValue('--border').trim(),
        accentColor: style.getPropertyValue('--accent').trim()
    };
}

function renderSalesChart(salesData) {
    const salesCtx = document.getElementById('salesChart');
    if (!salesCtx) return;

    const monthlySales = {};
    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    
    salesData.forEach(order => {
        const date = new Date(order.order_date);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth()).padStart(2, '0')}`;
        if (!monthlySales[monthKey]) {
            monthlySales[monthKey] = 0;
        }
        monthlySales[monthKey] += order.total_amount;
    });

    const sortedMonths = Object.keys(monthlySales).sort().slice(-6); // Last 6 months
    const chartLabels = sortedMonths.map(key => {
        const [year, month] = key.split('-');
        return `${monthNames[parseInt(month)]} ${year}`;
    });
    const chartData = sortedMonths.map(key => monthlySales[key]);

    const colors = getChartColors();

    if (salesChartInstance) salesChartInstance.destroy();
    salesChartInstance = new Chart(salesCtx, {
        type: 'bar',
        data: {
            labels: chartLabels,
            datasets: [{
                label: 'Total Sales',
                data: chartData,
                backgroundColor: `${colors.accentColor}99`, // Accent with 60% opacity
                borderColor: colors.accentColor,
                borderWidth: 1
            }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    ticks: { color: colors.textColor },
                    grid: { color: colors.gridColor }
                },
                x: {
                    ticks: { color: colors.textColor },
                    grid: { color: 'transparent' }
                }
            }
        }
    });
}

function renderInventoryChart(products) {
    const inventoryCtx = document.getElementById('inventoryChart');
    if (!inventoryCtx) return;

    const chartLabels = products.map(p => p.name);
    const chartData = products.map(p => p.stock_quantity);

    const colors = getChartColors();

    if (inventoryChartInstance) inventoryChartInstance.destroy();
    inventoryChartInstance = new Chart(inventoryCtx, {
        type: 'bar',
        data: {
            labels: chartLabels,
            datasets: [{
                label: 'Stock Quantity',
                data: chartData,
                backgroundColor: `${colors.accentColor}99`,
                borderColor: colors.accentColor,
                borderWidth: 1
            }]
        },
        options: { 
            indexAxis: 'y', 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    ticks: { color: colors.textColor },
                    grid: { color: 'transparent' }
                },
                x: {
                    ticks: { color: colors.textColor },
                    grid: { color: colors.gridColor }
                }
            }
        }
    });
}

let posOrder = []; // Array to hold { product, quantity }

async function loadPosProducts() {
    const grid = document.getElementById('posProductGrid');
    if (!grid) return;
    grid.innerHTML = '<p>Loading products...</p>';

    const { data: products, error } = await fetchAndCache('products_pos_list', () =>
        supabase.from('products').select('id, name, price, stock_quantity').eq('is_active', true).order('name')
    );

    if (error) {
        grid.innerHTML = '<p>Error loading products.</p>';
        return;
    }

    if (products && products.length > 0) {
        grid.innerHTML = products.map(p => `
            <div class="card" data-product-id="${p.id}" style="cursor: pointer; text-align: center; padding: 16px 12px;">
                <h3 style="font-size: 14px; min-height: 2.5em; display: flex; align-items: center; justify-content: center;">${p.name}</h3>
                <p style="font-weight: 600; color: var(--accent);">${formatCurrency(p.price)}</p>
                <p style="font-size: 11px;">Stock: ${p.stock_quantity}</p>
            </div>
        `).join('');

        // Add click listeners to new product cards
        grid.querySelectorAll('.card').forEach(card => {
            card.addEventListener('click', () => {
                const productId = parseInt(card.dataset.productId, 10);
                const product = products.find(p => p.id === productId);
                if (product) {
                    addToPosOrder(product);
                }
            });
        });
    } else {
        grid.innerHTML = '<p>No products found.</p>';
    }
}

function addToPosOrder(product) {
    const existingItem = posOrder.find(item => item.product.id === product.id);
    if (existingItem) {
        // Check if we can add one more
        if (existingItem.quantity < product.stock_quantity) {
            existingItem.quantity++;
        } else {
            alert(`Cannot add more of "${product.name}". Maximum stock (${product.stock_quantity}) reached.`);
        }
    } else {
        // Check if there is any stock to add it in the first place
        if (product.stock_quantity > 0) {
            posOrder.push({ product: product, quantity: 1 });
        } else {
            alert(`"${product.name}" is out of stock.`);
        }
    }
    renderPosOrder();
}

function renderPosOrder() {
    const itemsContainer = document.getElementById('posOrderItems');
    const summaryContainer = document.getElementById('posOrderSummary');
    if (!itemsContainer || !summaryContainer) return;

    if (posOrder.length === 0) {
        itemsContainer.innerHTML = '<p style="text-align: center; color: var(--muted); font-size: 13px;">No items added</p>';
        summaryContainer.innerHTML = '';
        return;
    }

    itemsContainer.innerHTML = posOrder.map(item => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 4px; font-size: 13px; border-bottom: 1px solid var(--border);">
            <div>
                <div style="font-weight: 500;">${item.product.name}</div>
                <div style="color: var(--muted);">${formatCurrency(item.product.price)}</div>
            </div>
            <div class="pos-item-controls">
                <button data-action="decrement" data-product-id="${item.product.id}">-</button>
                <span style="font-weight: 500; min-width: 20px; text-align: center;">${item.quantity}</span>
                <button data-action="increment" data-product-id="${item.product.id}">+</button>
                <div style="font-weight: 600; width: 80px; text-align: right;">${formatCurrency(item.product.price * item.quantity)}</div>
                <button data-action="remove" data-product-id="${item.product.id}" class="pos-item-remove" title="Remove item">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 16px; height: 16px;"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-1.1.26-1.99.833-2.7 1.517C2.52 6.417 2 7.444 2 8.571V13.5A2.5 2.5 0 0 0 4.5 16h11a2.5 2.5 0 0 0 2.5-2.5V8.571c0-1.127-.52-2.154-1.3-2.861-.71-.684-1.6-1.257-2.7-1.517v-.443A2.75 2.75 0 0 0 11.25 1h-2.5ZM7.5 3.75c0-.69.56-1.25 1.25-1.25h2.5c.69 0 1.25.56 1.25 1.25v.443c-.577.13-1.12.33-1.62.581a.75.75 0 0 1-.66 0c-.5-.251-1.043-.45-1.62-.581v-.443ZM10 10a.75.75 0 0 1 .75.75v2.5a.75.75 0 0 1-1.5 0v-2.5A.75.75 0 0 1 10 10ZM8.58 9.42a.75.75 0 0 0-1.16 1.16L9.19 12l-1.77 1.42a.75.75 0 1 0 .92 1.16l1.77-1.42 1.77 1.42a.75.75 0 1 0 .92-1.16L10.81 12l1.77-1.42a.75.75 0 1 0-.92-1.16l-1.77 1.42-1.77-1.42Z" clip-rule="evenodd" /></svg>
                </button>
            </div>
        </div>
    `).join('');

    // --- Advanced Tax Calculation from taxcalculator.html ---
    const cif = posOrder.reduce((sum, item) => sum + (item.product.price * item.quantity), 0); // Using subtotal as CIF
    const isTaxExempt = userPreferences.taxExempt || false;

    // Define tax rates (can be moved to settings later)
    const dutyPct = isTaxExempt ? 0 : 20;
    const excisePct = 0;
    const vatPct = isTaxExempt ? 0 : 15;
    const surtaxPct = isTaxExempt ? 0 : 10;
    const withholdingPct = isTaxExempt ? 0 : 3;
    const socialPct = isTaxExempt ? 0 : 3;

    const duty = cif * dutyPct/100;
    const excise = (cif + duty) * excisePct/100;
    const vat = (cif + duty + excise) * vatPct/100;
    const surtax = (cif + duty + excise + vat) * surtaxPct/100;
    const withholding = cif * withholdingPct/100;
    const social = cif * socialPct/100;

    const totalTaxes = duty + excise + vat + surtax + withholding + social;
    const total = cif + totalTaxes;

    summaryContainer.innerHTML = `
        <div style="display: flex; justify-content: space-between;"><span>Subtotal (CIF)</span><span>${formatCurrency(cif)}</span></div>
        <div style="display: flex; justify-content: space-between;"><span>Duty (${dutyPct}%)</span><span>${formatCurrency(duty)}</span></div>
        <div style="display: flex; justify-content: space-between;"><span>Excise (${excisePct}%)</span><span>${formatCurrency(excise)}</span></div>
        <div style="display: flex; justify-content: space-between;"><span>VAT (${vatPct}%)</span><span>${formatCurrency(vat)}</span></div>
        <div style="display: flex; justify-content: space-between;"><span>Surtax (${surtaxPct}%)</span><span>${formatCurrency(surtax)}</span></div>
        <div style="display: flex; justify-content: space-between;"><span>Withholding (${withholdingPct}%)</span><span>${formatCurrency(withholding)}</span></div>
        <div style="display: flex; justify-content: space-between;"><span>Social Levy (${socialPct}%)</span><span>${formatCurrency(social)}</span></div>
        <div style="display: flex; justify-content: space-between; font-weight: 600; font-size: 18px; padding-top: 8px; margin-top: 8px; border-top: 1px solid var(--border);"><span>Total</span><span>${formatCurrency(total)}</span></div>
    `;
}

function updatePosItem(productId, change) {
    const itemIndex = posOrder.findIndex(item => item.product.id === productId);
    if (itemIndex > -1) {
        // If incrementing, check against stock
        if (change > 0) {
            const item = posOrder[itemIndex];
            if (item.quantity >= item.product.stock_quantity) {
                alert(`Cannot add more of "${item.product.name}". Maximum stock (${item.product.stock_quantity}) reached.`);
                return; // Do not update quantity
            }
        }
        posOrder[itemIndex].quantity += change;
        if (posOrder[itemIndex].quantity <= 0) {
            posOrder.splice(itemIndex, 1); // Remove if quantity is 0 or less
        }
    }
    renderPosOrder();
}

function removePosItem(productId) {
    posOrder = posOrder.filter(item => item.product.id !== productId);
    renderPosOrder();
}

function setupPos() {
    document.getElementById('posClearBtn')?.addEventListener('click', () => {
        posOrder = [];
        renderPosOrder();
    });

    document.getElementById('posPayBtn')?.addEventListener('click', processPosPayment);
    document.getElementById('posSaveSaleBtn')?.addEventListener('click', savePendingSale);

    // Event delegation for order item controls
    document.getElementById('posOrderItems')?.addEventListener('click', (e) => {
        const button = e.target.closest('button');
        if (!button) return;

        const action = button.dataset.action;
        const productId = parseInt(button.dataset.productId, 10);

        if (action === 'increment') updatePosItem(productId, 1);
        if (action === 'decrement') updatePosItem(productId, -1);
        if (action === 'remove') removePosItem(productId);
    });

    // Search functionality
    document.getElementById('posProductSearch')?.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        document.querySelectorAll('#posProductGrid .card').forEach(card => {
            const productName = card.querySelector('h3').textContent.toLowerCase();
            card.style.display = productName.includes(query) ? '' : 'none';
        });
    });
}

async function loadPendingSales() {
    const container = document.getElementById('posPendingSales');
    if (!container) return;
    container.innerHTML = '<p>Loading pending sales...</p>';

    try {
        const { data: sales, error } = await supabase.from('sales_orders')
            .select('id, order_date, total_amount, customers(name), order_items(quantity, products(name, category))')
            .eq('status', 'pending')
            .order('order_date', { ascending: true });

        if (error) throw error;

        if (sales && sales.length > 0) {
            container.innerHTML = `
                <table class="data-table">
                    <thead><tr><th>Order</th><th>Customer</th><th>Items</th><th>Amount</th><th>Actions</th></tr></thead>
                    <tbody>${sales.map(sale => `
                        <tr>
                            <td>#${sale.id}</td>
                            <td>${sale.customers?.name || 'Walk-in'}</td>
                            <td style="font-size:12px;">${sale.order_items.map(i => `${i.quantity}x ${i.products.name}`).join(', ')}</td>
                            <td style="font-weight:600;">${formatCurrency(sale.total_amount)}</td>
                            <td class="actions-group">
                                <button class="action-btn" data-action="recall-sale" data-id="${sale.id}">Recall</button>
                                <button class="action-btn danger" data-action="delete-pending-sale" data-id="${sale.id}">Delete</button>
                            </td>
                        </tr>
                    `).join('')}</tbody>
                </table>`;
        } else {
            container.innerHTML = '<p>No pending sales.</p>';
        }
    } catch (error) {
        console.error('Error loading pending sales:', error);
        container.innerHTML = '<p>Error loading pending sales.</p>';
    }
}

async function recallSale(orderId) {
    const { data: sale, error } = await supabase.from('sales_orders')
        .select('*, order_items(*, products(*))')
        .eq('id', orderId)
        .single();

    if (error || !sale) {        showToast('Error recalling sale: ' + (error?.message || 'Sale not found'), 'error');
        return;
    }

    // Load items into the POS cart
    posOrder = sale.order_items.map(item => ({ product: item.products, quantity: item.quantity }));
    renderPosOrder();
}

async function loadPosRecentSales() {
    const container = document.getElementById('posRecentSales');
    if (!container) return;
    container.innerHTML = '<p>Loading recent sales...</p>';

    // Bypassing fetchAndCache for this specific function to ensure freshness after a sale.
    try {
        const { data: sales, error } = await supabase.from('sales_orders')
            .select('id, order_date, total_amount, customers(name), order_items(quantity, products(name, category))')
            .order('order_date', { ascending: false })
            .limit(5);

        if (error) throw error;

        if (sales && sales.length > 0) {
            const salesWithDetails = sales.map(sale => {
                const totalItems = sale.order_items.reduce((sum, item) => sum + item.quantity, 0);
                const itemSummary = sale.order_items
                    .map(item => `${item.quantity} x ${item.products.name}`)
                    .join(', ');
                return { ...sale, totalItems, itemSummary };
            });

            container.innerHTML = `
                <table class="data-table">
                    <thead><tr><th>Order</th><th>Customer</th><th>Items</th><th>Qty</th><th>Amount</th></tr></thead>
                    <tbody>${salesWithDetails.map(sale => `
                        <tr>
                            <td>#${sale.id}<br><span style="font-size:11px; color:var(--muted);">${new Date(sale.order_date).toLocaleString()}</span></td>
                            <td>${sale.customers?.name || 'Walk-in'}</td>
                            <td style="font-size:12px;">${sale.itemSummary || 'N/A'}</td>
                            <td>${sale.totalItems}</td>
                            <td style="font-weight:600;">${formatCurrency(sale.total_amount)}</td>
                        </tr>
                    `).join('')}</tbody>
                </table>`;
        } else {
            container.innerHTML = '<p>No recent sales found.</p>';
        }
    } catch (error) {
        console.error('Error loading recent POS sales:', error);
        container.innerHTML = '<p>Error loading recent sales.</p>';
    }
}

async function savePendingSale() {
    if (posOrder.length === 0) {
        showToast('No items in the order to save.', 'error');
        return;
    }

    const subtotal = posOrder.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
    const isTaxExempt = userPreferences.taxExempt || false;
    const taxRate = isTaxExempt ? 0 : 0.15;
    const tax = subtotal * taxRate;
    const totalAmount = subtotal + tax;

    const newSale = {
        status: 'pending',
        total_amount: totalAmount,
        order_date: new Date().toISOString()
    };

    try {
        const { data: saleData, error: saleError } = await supabase.from('sales_orders').insert(newSale).select().single();
        if (saleError) throw saleError;

        const orderItems = posOrder.map(item => ({
            order_id: saleData.id,
            product_id: item.product.id,
            quantity: item.quantity,
            unit_price: item.product.price
        }));
        const { error: itemsError } = await supabase.from('order_items').insert(orderItems);
        if (itemsError) throw itemsError;

        showToast('Sale saved as pending.');
        posOrder = [];
        renderPosOrder();
        loadPendingSales(); // Refresh the pending sales list

    } catch (error) {
        console.error('Error saving pending sale:', error);
        showToast(`Error saving sale: ${error.message}`, 'error');
    }
}

async function deletePendingSale(orderId) {
    if (!confirm(`Are you sure you want to delete pending sale #${orderId}? This cannot be undone.`)) return;
    // Because of foreign key constraints with ON DELETE CASCADE, deleting the sales_order will also delete its order_items.
    const { error } = await supabase.from('sales_orders').delete().eq('id', orderId);
    if (error) showToast('Error deleting sale: ' + error.message, 'error');
    else loadPendingSales(); // Refresh list
}

async function processPosPayment() {
    if (posOrder.length === 0) {        showToast('No items in the order to process payment.', 'error');
        return;
    }

    // Client-side stock validation before processing payment
    for (const item of posOrder) {
        // We need to find the most up-to-date product info, which might be in the POS product list
        const productInGrid = (await fetchAndCache('products_pos_list', () => supabase.from('products').select('*'))).data.find(p => p.id === item.product.id);
        const currentStock = productInGrid ? productInGrid.stock_quantity : item.product.stock_quantity;

        if (item.quantity > currentStock) {
            showToast(`Insufficient stock for "${item.product.name}". Only ${currentStock} available.`, 'error');
            return; // Stop the transaction
        }
    }

    // --- Advanced Tax Calculation from taxcalculator.html ---
    const cif = posOrder.reduce((sum, item) => sum + (item.product.price * item.quantity), 0); // Using subtotal as CIF
    const isTaxExempt = userPreferences.taxExempt || false;

    const dutyPct = isTaxExempt ? 0 : 20;
    const excisePct = 0;
    const vatPct = isTaxExempt ? 0 : 15;
    const surtaxPct = isTaxExempt ? 0 : 10;

    const duty = cif * dutyPct/100;
    const excise = (cif + duty) * excisePct/100;
    const vat = (cif + duty + excise) * vatPct/100;
    const surtax = (cif + duty + excise + vat) * surtaxPct/100;

    const totalTaxes = duty + excise + vat + surtax; // Simplified for sale record
    const totalAmount = cif + totalTaxes;

    // For POS, we can use a generic customer or null if the schema allows.
    // Let's assume customer_id 1 is "Walk-in Customer" or we can pass null.
    const newSale = {
        // customer_id: 1, 
        status: 'completed',
        total_amount: totalAmount,
        order_date: new Date().toISOString()
    };

    try {
        // Step 1: Insert the sales order
        const { data: saleData, error: saleError } = await supabase
            .from('sales_orders')
            .insert(newSale)
            .select()
            .single();

        if (saleError) throw saleError;

        // Step 2: Insert the order items
        const orderItems = posOrder.map(item => ({
            order_id: saleData.id,
            product_id: item.product.id,
            quantity: item.quantity,
            unit_price: item.product.price
        }));
        const { error: itemsError } = await supabase.from('order_items').insert(orderItems);
        if (itemsError) throw itemsError;

        // Step 2: Update stock quantities for each product sold
        const stockUpdates = posOrder.map(item => 
            supabase.rpc('decrement_stock', { 
                p_id: item.product.id, 
                p_quantity: item.quantity 
            })
        );
        
        await Promise.all(stockUpdates);

        showToast(`Sale successful! Total: ${formatCurrency(totalAmount)}`);
        posOrder = [];
        renderPosOrder();
        
        // Invalidate cache and force a reload of recent sales to show the new one.
        // We call loadPosRecentSales directly to bypass the app's cache and ensure
        // we get the newly created order_items.
        appCache['pos_recent_sales'] = null;
        loadPosRecentSales();

    } catch (error) {
        console.error('Error processing payment:', error);
        showToast(`Error processing payment: ${error.message}`, 'error');
    }
}

function setupSettingsActions() {
    const deleteAllBtn = document.getElementById('deleteAllRecordsBtn');
    if (deleteAllBtn) {
        deleteAllBtn.addEventListener('click', async () => {
            const confirmation = prompt('This will delete all sales, orders, and other transactional data. This cannot be undone. Type "DELETE" to confirm.');
            if (confirmation === 'DELETE') {
                try {                    showToast('Deleting records... Please wait.');

                    // Call the server-side function to handle deletion atomically.
                    const { error } = await supabase.rpc('delete_all_transactional_data');

                    if (error) {
                        // The error might be due to permissions or a function issue.
                        throw new Error(`RPC Error: ${error.message}`);
                    }

                    showToast('All transactional records have been deleted. The application will now refresh.');
                    
                    // 1. Clear the application's in-memory cache
                    Object.keys(appCache).forEach(key => delete appCache[key]); // Clear the in-memory cache
                    
                    // 2. Force a refresh of the Supabase client's session and cache
                    await supabase.auth.refreshSession();

                    // 3. Reload the page to ensure a clean state and re-fetch of all data
                    window.location.reload();

                } catch (error) {
                    console.error('Error during record deletion:', error);                    showToast(`An error occurred during deletion: ${error.message}`, 'error');
                }
            } else {
                showToast('Deletion cancelled.');
            }
        });
    }

    const themeSelector = document.getElementById('themeSelector');
    if (themeSelector) {
        themeSelector.addEventListener('change', (e) => {
            updatePreference('theme', e.target.value).then(applyPreferences);
        });
    }
}
// --- App Initialization ---
async function initApp() {
  // Add event listeners
  document.getElementById('modalCloseBtn')?.addEventListener('click', closeModal);

  sidebarToggleBtn.addEventListener('click', () => {
    if (window.innerWidth <= 880) {
      // Mobile view: toggle overlay menu
      appEl.classList.toggle('sidebar-mobile-open');
      document.getElementById('mobileMenuOverlay').style.display = appEl.classList.contains('sidebar-mobile-open') ? 'block' : 'none';
    } else {
      // Desktop view: toggle collapsed state
      appEl.classList.toggle('sidebar-collapsed');
      const isCollapsed = appEl.classList.contains('sidebar-collapsed');
      localStorage.setItem('sidebarCollapsed', isCollapsed);
      // Redraw charts to fit new container size
      setTimeout(() => { if (window.salesChartInstance) window.salesChartInstance.resize(); if (window.inventoryChartInstance) window.inventoryChartInstance.resize(); }, 300);
    }
  });

  // Close mobile menu when overlay is clicked
  document.getElementById('mobileMenuOverlay').addEventListener('click', () => {
    appEl.classList.remove('sidebar-mobile-open');
    document.getElementById('mobileMenuOverlay').style.display = 'none';
  });
  signInBtn.addEventListener('click', signIn);

  // Centralized event listener for dynamic content
  pageContent.addEventListener('click', (e) => {
    const target = e.target.closest('[data-action]');
    if (!target) return;
    const { action, id } = target.dataset;

    if (action === 'navigate') setActive(target.dataset.page);
    if (action === 'open-product-modal') openProductModal();
    if (action === 'edit-product') openProductModal(parseInt(id, 10));
    if (action === 'delete-product') deleteProduct(parseInt(id, 10));
    if (action === 'restock-product') openRestockModal(parseInt(id, 10));
    if (action === 'recall-sale') recallSale(parseInt(id, 10));
    if (action === 'delete-pending-sale') deletePendingSale(parseInt(id, 10));
  });


  passwordInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') signIn(); });
  signOutBtn.addEventListener('click', signOut);

  // Check initial auth state
  const { data } = await supabase.auth.getSession();
  if (data.session?.user) {
    await showApp(data.session.user);
  } else {
    // If no user, show the login screen
    loginScreen.classList.add('visible');
  }

  // Apply saved sidebar state
  if (localStorage.getItem('sidebarCollapsed') === 'true') {
    appEl.classList.add('sidebar-collapsed');
  }
}

attachToggleListeners();
initApp();


window.setActive = setActive; // Expose to global scope for inline handlers that still exist
navButtons.forEach(b=>b.addEventListener('click',()=>setActive(b.dataset.key)));

// --- Search Functionality ---
sidebarSearch.addEventListener('input',e=>{
  const q=e.target.value.toLowerCase().trim();
  document.querySelectorAll('#navList button').forEach(b=>{
    b.style.display=b.textContent.toLowerCase().includes(q)?'flex':'none';
  });
});

window.addEventListener('afterprint', () => {
  document.body.classList.remove('printing');
});

</script>
</body>
</html>

